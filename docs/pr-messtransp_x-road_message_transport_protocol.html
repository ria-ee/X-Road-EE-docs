<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="github-markdown.css">
    <style>
      .markdown-body {
        box-sizing: border-box;
        min-width: 200px;
        max-width: 980px;
        margin: 0 auto;
        padding: 45px;
      }
    </style>
    <title>X-Road: 7.4.2
</title>
  </head>
  <body>
    <article class="markdown-body">
<div class="markdown-heading"><h1 class="heading-element">X-Road: Message Transport Protocol</h1><a id="x-road-message-transport-protocol" class="anchor" aria-label="Permalink: X-Road: Message Transport Protocol" href="#x-road-message-transport-protocol"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p><strong>Technical Specification</strong></p>
<p>Version: 2.6<br>
01.06.2023<br>
Doc. ID: PR-MESSTRANSP</p>
<hr>
<div class="markdown-heading"><h2 class="heading-element">Version history</h2><a id="version-history" class="anchor" aria-label="Permalink: Version history" href="#version-history"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<table>
<thead>
<tr>
<th>Date</th>
<th>Version</th>
<th>Description</th>
<th>Author</th>
</tr>
</thead>
<tbody>
<tr>
<td>01.07.2015</td>
<td>0.6</td>
<td>Translated to English</td>
<td>Siim Annuk</td>
</tr>
<tr>
<td>14.07.2015</td>
<td>0.7</td>
<td>Total restructuring</td>
<td>Ilja Kromonov</td>
</tr>
<tr>
<td>11.08.2015</td>
<td>0.8</td>
<td>Comments added</td>
<td>Margus Freudenthal</td>
</tr>
<tr>
<td>11.08.2015</td>
<td>0.9</td>
<td>Fixes according to comments</td>
<td>Siim Annuk</td>
</tr>
<tr>
<td>27.08.2015</td>
<td>1.0</td>
<td>Minor improvements</td>
<td>Siim Annuk</td>
</tr>
<tr>
<td>28.08.2015</td>
<td>1.1</td>
<td>Comments and editorial changes</td>
<td>Margus Freudenthal</td>
</tr>
<tr>
<td>28.08.2015</td>
<td>1.2</td>
<td>More fixes according to comments</td>
<td>Siim Annuk</td>
</tr>
<tr>
<td>31.08.2015</td>
<td>1.3</td>
<td>Made minor editorial changes</td>
<td>Margus Freudenthal</td>
</tr>
<tr>
<td>09.09.2015</td>
<td>2.0</td>
<td>Editorial changes made</td>
<td>Imbi Nõgisto</td>
</tr>
<tr>
<td>14.10.2015</td>
<td>2.1</td>
<td>Changes added about HTTP headers and attachments. Ports 5500 and 5577 are default configuration.</td>
<td>Siim Annuk</td>
</tr>
<tr>
<td>17.10.2015</td>
<td>2.2</td>
<td>Anchored the figures in place</td>
<td>Margus Freudenthal</td>
</tr>
<tr>
<td>01.03.2019</td>
<td>2.3</td>
<td>X-Request-Id header</td>
<td>Caro Hautamäki</td>
</tr>
<tr>
<td>04.03.2019</td>
<td>2.4</td>
<td>Converted into Markdown</td>
<td>Caro Hautamäki</td>
</tr>
<tr>
<td>22.10.2020</td>
<td>2.5</td>
<td>Added REST message protocol</td>
<td>Janne Mattila</td>
</tr>
<tr>
<td>01.06.2023</td>
<td>2.6</td>
<td>Update references</td>
<td>Petteri Kivimäki</td>
</tr>
</tbody>
</table>
<div class="markdown-heading"><h2 class="heading-element">Table of Contents</h2><a id="table-of-contents" class="anchor" aria-label="Permalink: Table of Contents" href="#table-of-contents"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>

<ul>
<li><a href="#license">License</a></li>
<li>
<a href="#1-introduction">1 Introduction</a>
<ul>
<li><a href="#11-overview">1.1 Overview</a></li>
<li><a href="#12-terms-and-abbreviations">1.2 Terms and Abbreviations</a></li>
<li><a href="#13-references">1.3 References</a></li>
</ul>
</li>
<li>
<a href="#2-transport-layer">2 Transport Layer</a>
<ul>
<li><a href="#21-tls-authentication">2.1 TLS Authentication</a></li>
<li><a href="#22-downloading-ocsp-responses-from-service-provider">2.2 Downloading OCSP Responses from Service Providers</a></li>
</ul>
</li>
<li>
<a href="#3-application-layer">3 Application Layer</a>
<ul>
<li><a href="#31-x-road-transport-message">3.1 X-road Transport Message</a></li>
<li><a href="#32-message-handling-in-service-clients-security-server">3.2 Message Handling in Service Client's Security Server</a></li>
<li><a href="#33-message-handling-in-service-providers-security-server">3.3 Message Handling in Service Provider's Security Server</a></li>
</ul>
</li>
<li>
<a href="#4-annex-example-messages">4 Annex: Example Messages</a>
<ul>
<li><a href="#41-response-to-ocsp-downloading-request">4.1 Response to OCSP Downloading Request</a></li>
<li><a href="#42-simple-soap-request">4.2 Simple SOAP Request</a></li>
<li><a href="#43-simple-soap-response">4.3 Simple SOAP Response</a></li>
<li><a href="#44-soap-request-with-attachments">4.4 SOAP Request with Attachments</a></li>
<li><a href="#45-soap-response-with-fault-as-last-part">4.5 SOAP Response with Fault as Last Part</a></li>
<li><a href="#46-rest-request">4.6 REST Request</a></li>
<li><a href="#47-rest-response">4.7 REST Response</a></li>
</ul>
</li>
</ul>

<div class="markdown-heading"><h2 class="heading-element">License</h2><a id="license" class="anchor" aria-label="Permalink: License" href="#license"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>This document is licensed under the Creative Commons Attribution-ShareAlike 3.0 Unported License. To view a copy of this license, visit <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="nofollow">http://creativecommons.org/licenses/by-sa/3.0/</a></p>
<div class="markdown-heading"><h2 class="heading-element">1 Introduction</h2><a id="1-introduction" class="anchor" aria-label="Permalink: 1 Introduction" href="#1-introduction"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>This document describes the communications protocol that is used by service client's and service provider's security servers to exchange messages with each other.</p>
<div class="markdown-heading"><h3 class="heading-element">1.1 Overview</h3><a id="11-overview" class="anchor" aria-label="Permalink: 1.1 Overview" href="#11-overview"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p><a id="Messtransport_protocol_overview"></a>
<a target="_blank" rel="noopener noreferrer" href="img/pr-messtransport-protocol-overview.png"><img src="img/pr-messtransport-protocol-overview.png" alt="" style="max-width: 100%;"></a></p>
<p>Figure 1. Protocols used in the X-Road system</p>
<p>As can be seen from <a href="#Messtransport_protocol_overview">Figure 1</a>, three protocols are involved when exchanging messages between a service client and a service provider. These include:</p>
<ul>
<li>
<p>X-Road message protocol – used for communication between an information system and a security server within an organization</p>
<ul>
<li>There are two types of X-Road message protocols, one for SOAP and one for REST</li>
<li>X-Road message protocol (for SOAP) is a profile of the SOAP protocol (<a href="http://www.w3.org/TR/2000/NOTE-SOAP-20000508/" rel="nofollow">http://www.w3.org/TR/2000/NOTE-SOAP-20000508/</a>).
See <a href="#Ref_PR-MESS">PR-MESS</a> for details.</li>
<li>X-Road message protocol for REST is a protocol for consuming and producing REST services.
See <a href="#Ref_PR-REST">PR-REST</a> for details.</li>
<li>Same message protocol needs to be used in both ends. Using <em>message protocol for REST</em> between service client's information system and
security server, and <em>message protocol for SOAP</em> between service provider's security server and information system is not supported.</li>
</ul>
</li>
<li>
<p>X-Road message transport protocol – a synchronous secure communication protocol that provides confidentiality and integrity when exchanging messages between two security servers over the public Internet. This protocol is described in the current document.</p>
</li>
<li>
<p>OCSP Response Retrieval Protocol – the protocol used in parallel with the X-Road message transport protocol when establishing a secure communications channel between the service client's and the service provider's security servers (see <a href="#22-downloading-ocsp-responses-from-service-provider">Section 2.2</a> for details).</p>
</li>
</ul>
<p>The communication protocol is divided into two layers (<a href="#Messtransport_protocol_layers">Figure 2</a>) – the transport layer and the application layer. The transport layer uses HTTP over mutually authenticated TLS; see  <a href="#2-transport-layer">Section 2</a>  for details on how the TLS session is established. The application layer consists of MIME multipart encoded X-Road transport messages that are exchanged over the transport layer (HTTPS); see <a href="#3-application-layer">Section 3</a> for the exact format of the message and how it's processed.</p>
<p>The service client's security server encapsulates the request message it receives from the service client into an X-Road transport message and in turn receives an X-Road transport message (message format described in <a href="#31-x-road-transport-message">Section 3.1</a>) from the service provider's security server before forwarding the encapsulated response back to the service client (process described in detail in <a href="#32-message-handling-in-service-clients-security-server">Section 3.2</a>).</p>
<p>The service provider's security server receives the X-Road transport message from the service client's security server and forwards the encapsulated request message to the service provider. The service provider's security server encapsulates the response from the service provider into an X-Road transport message and sends it to the service client's security server (process described in detail in <a href="#33-message-handling-in-service-providers-security-server">Section 3.3</a>).</p>
<p>Chapters <a href="#2-transport-layer">2</a> and <a href="#3-application-layer">3</a>, as well as the annex of this specification contain normative information. All the other sections are informative in nature. All the references are normative.</p>
<p>This specification does not include option for partially implementing the protocol – the conformant implementation must implement the entire specification.</p>
<p><a id="Messtransport_protocol_layers"></a>
<a target="_blank" rel="noopener noreferrer" href="img/pr-messtransport-protocol-layers.png"><img src="img/pr-messtransport-protocol-layers.png" alt="" style="max-width: 100%;"></a></p>
<p>Figure 2. Layers of the X-Road message transport protocol</p>
<div class="markdown-heading"><h3 class="heading-element">1.2 Terms and Abbreviations</h3><a id="12-terms-and-abbreviations" class="anchor" aria-label="Permalink: 1.2 Terms and Abbreviations" href="#12-terms-and-abbreviations"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>See X-Road terms and abbreviations documentation [<a href="#Ref_TERMS">TA-TERMS</a>].</p>
<div class="markdown-heading"><h3 class="heading-element">1.3 References</h3><a id="13-references" class="anchor" aria-label="Permalink: 1.3 References" href="#13-references"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ol>
<li>
<p><a id="Ref_PR-SIGDOC"></a>[PR-SIGDOC] Freudenthal, Margus. Profile for High-Perfomance Digital Signature. Cybernetica Research Reports, T-4-23, 2015 <a href="https://cyber.ee/research/reports/" rel="nofollow">https://cyber.ee/research/reports/</a></p>
</li>
<li>
<p><a id="Ref_BATCH-TS"></a>[BATCH-TS] Freudenthal, Margus. Using Batch Hashing for Signing and Time-Stamping. Cybernetica Research Reports, T-4-20, 2013 <a href="https://cyber.ee/research/reports/" rel="nofollow">https://cyber.ee/research/reports/</a></p>
</li>
<li>
<p><a id="Ref_PR-MESS"></a>[PR-MESS] X-Road: Message Protocol v4.0. Document ID: <a href="pr-mess_x-road_message_protocol.html">PR-MESS</a>.</p>
</li>
<li>
<p><a id="Ref_TERMS"></a>[TA-TERMS] X-Road Terms and Abbreviations. Document ID: <a href="terms_x-road_docs.html">TA-TERMS</a>.</p>
</li>
<li>
<p><a id="Ref_PR-REST"></a>[PR-REST] X-Road: Message Protocol for REST. Document ID: <a href="pr-rest_x-road_message_protocol_for_rest.html">PR-REST</a>.</p>
</li>
</ol>
<div class="markdown-heading"><h2 class="heading-element">2 Transport Layer</h2><a id="2-transport-layer" class="anchor" aria-label="Permalink: 2 Transport Layer" href="#2-transport-layer"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="markdown-heading"><h3 class="heading-element">2.1 TLS Authentication</h3><a id="21-tls-authentication" class="anchor" aria-label="Permalink: 2.1 TLS Authentication" href="#21-tls-authentication"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>Security servers use authentication certificates to initiate a mutually authenticated message exchange. Each security server's authentication certificate must be registered at the central server. The certification service provider that issued these certificates must be approved by the central server. Therefore, certificate chains constructed when authenticating the connection must include certificates up to the issuing certificate of the trusted certification service provider that is registered at the central server as an approved certification authority.</p>
<p>The process of establishing of a secure communication channel can be described by the following steps.</p>
<ol>
<li>
<p>An X-Road request message arrives at the service client's security server.</p>
</li>
<li>
<p>Service client's security server processes the request and determines the target service provider's security server.</p>
</li>
<li>
<p>Service client's security server initiates the TLS handshake with the target service provider's security server on port 5500 (default configuration).</p>
</li>
<li>
<p>Service client's security server receives the authentication certificate chain of the service provider's security server as part of the TLS handshake.</p>
</li>
<li>
<p>Service client's security server checks if the local OCSP cache contains OCSP responses for the received certificates.</p>
</li>
<li>
<p>If the OCSP responses are not cached, the service client's security server must download them from the service provider's security server and cache them locally (see <a href="#22-downloading-ocsp-responses-from-service-provider">Section 2.2</a> for details).</p>
</li>
<li>
<p>Service client's security server verifies that the authentication certificate of the service provider's security server was issued by an approved certification service provider and builds the certification chain for the authentication certificate. The certification chain and corresponding OCSP responses are then verified.</p>
</li>
<li>
<p>If verification is successful, the service client's security server forwards the X-Road transport message to the service provider's security server. If verification failed, the service client's security server sends a SOAP Fault message back to the service client's information system.</p>
</li>
<li>
<p>Having received the X-Road transport message, the service provider's security server verifies the service client's authentication certificate chain using the global configuration.</p>
</li>
</ol>
<p>This process is illustrated in the sequence diagram in Figure 3.</p>
<p><a id="Messtransport_protocol_auth"></a>
<a target="_blank" rel="noopener noreferrer" href="img/pr-messtransport-protocol-auth.png"><img src="img/pr-messtransport-protocol-auth.png" alt="" style="max-width: 100%;"></a></p>
<p>Figure 3. TLS authentication</p>
<div class="markdown-heading"><h3 class="heading-element">2.2 Downloading OCSP Responses from Service Provider</h3><a id="22-downloading-ocsp-responses-from-service-provider" class="anchor" aria-label="Permalink: 2.2 Downloading OCSP Responses from Service Provider" href="#22-downloading-ocsp-responses-from-service-provider"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>Each X-Road security server only interacts with the CA that issued the certificates used by it. For this reason, the OCSP responses for certificates are always transferred together with the certificates themselves. The security servers cache the OCSP responses for their certificates and periodically update this cache.</p>
<p>The service client's security server sends the OCSP responses for authentication certificate as part of the request message. However, before sending the request the client's security server must verify service provider's security server's authentication certificate. Because the OCSP stapling specification is not widely implemented yet, the client's security server downloads the OCSP responses from the service provider's security server using a separate channel (HTTP).</p>
<p>Service provider's security server must respond to HTTP GET requests to port 5577 (default configuration). In the HTTP GET request the client's security server indicates the certificates whose OCSP responses are requested. For this, the client includes cert query parameters whose content is hexadecimally encoded SHA-1 hashes of the certificates. For example, the following URL is used to retrieve OCSP responses for two certificates:</p>
<p><code>http://SECURITYSERVER:5577/?cert=a1b2c3d4e5&amp;cert=f6g7h8i9j0</code></p>
<p>where SECURITYSERVER is the address of the service provider's security server.</p>
<p>As a response to this request the service responds with a MIME multipart message (<code>multipart/related</code>). Each part of this message must contain a requested OCSP responses with content-type <code>application/ocsp-response</code>. See Annex <a href="#41-response-to-ocsp-downloading-request">4.1</a> for an example response.</p>
<div class="markdown-heading"><h2 class="heading-element">3 Application Layer</h2><a id="3-application-layer" class="anchor" aria-label="Permalink: 3 Application Layer" href="#3-application-layer"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>The integrity of transmitted message is ensured by signing the X-Road transport message in the security server. The signature can be either a regular signature or a batch signature. Batch signatures must be created for messages that contain attachments. If a signing key is located on a slow secure signature creation device then batch signatures may be used when signing many messages simultaneously. See [<a href="#Ref_PR-SIGDOC">PR-SIGDOC</a>] for more information about how signatures are created.</p>
<p>The X-Road message transport protocol is designed for streaming the message contents (e.g. attachments) between security servers. The signature can be calculated after the previous parts (e.g. attachments) of the transport message have been transferred to the other party. Streaming the message contents puts restrictions on how the signature of the transport message must be verified. The contents of the transport message must be cached in the security server before the signature of the message can be verified, because the verification result determines the validity of the message – the security server must not forward an invalid message to the other party.</p>
<div class="markdown-heading"><h3 class="heading-element">3.1 X-Road Transport Message</h3><a id="31-x-road-transport-message" class="anchor" aria-label="Permalink: 3.1 X-Road Transport Message" href="#31-x-road-transport-message"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p><a id="Messtransport_message"></a>
<a target="_blank" rel="noopener noreferrer" href="img/pr-messtransport-message.svg"><img src="img/pr-messtransport-message.svg" alt="" style="max-width: 100%;"></a></p>
<p>Figure 4. X-Road transport messages</p>
<p>The X-Road transport messages are encoded as MIME multipart messages with content-type <code>multipart/mixed</code>.</p>
<p>For SOAP messages, the content-type of the client request message is sent from the service client's security server
to the service provider's security server and vice versa using the <code>x-original-content-type</code> HTTP header.
The value of the original content type is used to forward the request or response message to the service provider's
or service client's information system. All other HTTP headers sent by the service client's security server or service
provider's security server are not preserved in the security server. MIME headers in the multipart message are preserved.</p>
<p>For REST messages, the content-type of the client request message is sent from the service client's security server
to the service provider's security server and vice versa using the <code>application/x-road-rest-request</code> and
<code>application/x-road-rest-response</code> parts, which contain "REST header part" of the REST request or response.
REST header part consists of HTTP request line (for requests), HTTP status line (for responses), and HTTP headers (for both).
Besides <code>Content-Type</code> header, also other headers may be preserved by the security server, but the processing varies.
Some new headers are added (replaced if one already exists) by the security server, for example <code>x-road-request-id</code>.
Some headers will be removed, for example <code>User-Agent</code>.
All other headers are passed through as-is, for example <code>X-Powered-By</code>.
For details, see [<a href="#Ref_PR-REST">PR-REST</a>] and "Use of HTTP Headers".</p>
<p>The X-Road transport message encapsulates either the SOAP/REST message package that arrives to the security server or a
SOAP fault message (uses content-type <code>text/xml</code> instead of <code>multipart/mixed</code>). The latter is only sent from the
service provider's security server to the service client's security server if an error occurred before processing the
request message in the service provider's security server. The normal X-Road request message must consist of the
following MIME message parts (see <a href="#Messtransport_message">Figure 4</a>). The parts are mandatory unless stated otherwise:</p>
<ol>
<li>
<p>byte contents of OCSP responses (content-type <code>application/ocsp-response</code>) of the service client's security server authentication certificate chain that was used to authenticate the TLS connection;</p>
</li>
<li>
<p>(optional, either this or REST message must exist) the SOAP message (content-type <code>text/xml</code> or <code>application/xop+xml</code> in case the original message is a MTOM-encoded SOAP message package);</p>
</li>
<li>
<p>(optional) a nested MIME multipart (content-type <code>multipart/mixed</code>) containing all attachments as parts. This part is only present if the original SOAP message package contains attachments;</p>
</li>
<li>
<p>(optional, either this or SOAP message must exist) the REST message header (content-type <code>application/x-road-rest-request</code>)</p>
</li>
<li>
<p>(optional) a REST request body (content-type <code>application/x-road-rest-body</code>) This part is only present if the REST request contains a body.</p>
</li>
<li>
<p>(optional) if the signature is a batch signature, then:</p>
<p>a) the hash chain result XML (content-type <code>application/hash-chain-result</code>) and</p>
<p>b)	the hash chain XML (content-type <code>application/hash-chain</code>) of the signature.</p>
</li>
<li>
<p>the signature XML (content-type <code>signature/bdoc-1.0/ts</code>) associated with the SOAP/REST message and any attachments of the encapsulated message;</p>
</li>
</ol>
<p>The normal X-Road response message must consist of the following MIME message parts (see <a href="#Messtransport_message">Figure 4</a>). The parts are mandatory unless stated otherwise:</p>
<ol>
<li>
<p>(optional, either this or REST message must exist) the SOAP message (content-type <code>text/xml</code> or <code>application/xop+xml</code> in case the original message is a MTOM-encoded SOAP message package);</p>
</li>
<li>
<p>(optional) a nested MIME multipart (content-type `multipart/mixed) containing all attachments as parts. This part is only present if the original SOAP message package contains attachments;</p>
</li>
<li>
<p>(optional, either this or SOAP message must exist) the REST message header (content-type <code>application/x-road-rest-response</code>)</p>
</li>
<li>
<p>(optional) a REST response body (content-type <code>application/x-road-rest-body</code>) This part is only present if the REST response contains a body.</p>
</li>
<li>
<p>(optional) if the signature is a batch signature, then:</p>
<p>a)	the hash chain result XML (content-type <code>application/hash-chain-result</code>) and</p>
<p>b)	the hash chain XML (content-type <code>application/hash-chain</code>) of the signature.</p>
</li>
<li>
<p>one of the following:</p>
<p>a)	the signature XML (content-type <code>signature/bdoc-1.0/ts</code>) associated with the SOAP message and any attachments of the encapsulated message; or</p>
<p>b)	a SOAP fault XML (content-type <code>text/xml</code>), if any errors occurred during the processing of the message (i.e. error when creating signature). Since the previous parts of the message have already been sent to the other party, the SOAP fault must be sent as the last part.</p>
</li>
</ol>
<div class="markdown-heading"><h3 class="heading-element">3.2 Message Handling in Service Client's Security Server</h3><a id="32-message-handling-in-service-clients-security-server" class="anchor" aria-label="Permalink: 3.2 Message Handling in Service Client's Security Server" href="#32-message-handling-in-service-clients-security-server"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>The following describes the actions that the service client's security server must take in order to perform a secure message exchange between a service client and a service provider.</p>
<ol>
<li>
<p>Receive a REST request, SOAP message or a SOAP message package (if attachments are present) from the service client (message format described in <a href="#Ref_PR-MESS">PR-MESS</a>).</p>
</li>
<li>
<p>Parse either the SOAP message or <code>X-Road-Client</code> header to determine the target service provider.</p>
</li>
<li>
<p>Establish TLS connection with it's security server (see <a href="#21-tls-authentication">Section 2.1</a>).</p>
</li>
<li>
<p>Send an X-Road transport message to the service provider's security server (message format described in <a href="#31-x-road-transport-message">Section 3.1</a>) in the following steps:</p>
<p>a)	For SOAP and REST messages, add the following HTTP headers to the HTTP headers of the HTTP request:</p>
<ul>
<li>
<p>UUID (<code>x-road-request-id</code>). The id is shared between request/response pairs so one can easily find corresponding messages from logs if needed.</p>
</li>
<li>
<p>Hash algorithm identifier (<code>x-hash-algorithm</code>). The hash algorithm is used by the other party to calculate the hashes of the message parts to be used during message verification.</p>
</li>
<li>
<p>Original content type (<code>x-original-content-type</code>) of the request message.</p>
</li>
<li>
<p>Version (<code>x-proxy-version</code>) of the client X-Road proxy</p>
</li>
<li>
<p>(only for SOAP messages) original SOAPAction (<code>x-original-soapaction</code>)</p>
</li>
</ul>
<p>b)	For REST messages, add the following additional HTTP header:</p>
<ul>
<li>Message type discriminator (<code>x-road-message-type</code>) with value <code>REST</code>
</li>
</ul>
<p>c) Write an OCSP response part to the transport message (content-type <code>application/ocsp-response</code>) for each OCSP response in the authentication certificate chain used for establishing the TLS connection.</p>
<p>d) For SOAP messages, write the service client's request SOAP message (content-type <code>text/xml</code> or <code>application/xop+xml</code> in case the original message is a MTOM-encoded SOAP message package) to the transport message. Calculate the hash of the request SOAP message.</p>
<p>e) If the original request was a SOAP message package, write a nested MIME multipart (content-type <code>multipart/mixed</code>) containing all attachments as parts. Copy the MIME headers of each attachment part and calculate the hash of the data.</p>
<p>f) For REST messages, write the REST request header part (content-type <code>application/x-road-rest-request</code>). This part contains HTTP request line and HTTP headers. Calculate the hash of this part.</p>
<ul>
<li>
<p>Some new headers must be added (replaced if one already exists) by the security server, for example <code>x-road-request-id</code></p>
</li>
<li>
<p>Some headers must be removed, for example <code>User-Agent</code></p>
</li>
<li>
<p>All other headers must be copied from original request as-is, for example <code>X-Powered-By</code></p>
</li>
<li>
<p>For details, see [<a href="#Ref_PR-REST">PR-REST</a>] and "Use of HTTP Headers"</p>
</li>
</ul>
<p>g) For REST messages with a request body, write the part containing the REST request body (content-type <code>application/x-road-rest-body</code>). Calculate the hash of the body.</p>
<p>h) Calculate the signature using the stored message and attachment hashes in accordance with [<a href="#Ref_PR-SIGDOC">PR-SIGDOC</a>, <a href="#Ref_BATCH-TS">BATCH-TS</a>]. Write the signature as the last part of the message (content-type <code>signature/bdoc-1.0/ts</code>).</p>
</li>
<li>
<p>Start reading a response from the target service provider's security server (message format described in <a href="#31-x-road-transport-message">Section 3.1</a>.</p>
</li>
<li>
<p>If the content-type of the response is <code>multipart/mixed</code> then process the message parts as follows:</p>
<p>a) The first part must be the encapsulated SOAP response message or REST response message. The message is not forwarded to the service client until it can be verified.</p>
<p>b) SOAP response is identified by content-type <code>text/xml</code> or <code>application/xop+xml</code> in case the response is a MTOM-encoded SOAP message package.</p>
<ol>
<li>If the content-type of the next part is <code>multipart/mixed</code> then this part is the nested attachments multipart.</li>
</ol>
<p>c) REST response is identified by content-type <code>application/x-road-rest-response</code></p>
<ol>
<li>
<p>REST response header part has content-type <code>application/x-road-rest-response</code>. This part contains the HTTP status line and HTTP headers.</p>
</li>
<li>
<p>If the content-type of the next part is <code>application/x-road-rest-body</code> then this part is the body of the REST response. For responses without a body, this part does not exist.</p>
</li>
</ol>
<p>d) If the content-type of the next part is <code>application/hash-chain-result</code> then this message contains a batch signature. The hash chain result is stored for message verification.</p>
<p>e) If the content-type of the next part is <code>application/hash-chain</code> then this message contains a batch signature. The hash chain is stored for message verification. The hash chain result must be present if the hash chain is present.</p>
<p>f) If the content-type of the last part is <code>signature/bdoc-1.0/ts</code> then the part contains the signature of the message. If the content-type of the part is <code>text/xml</code> then the part contains a SOAP fault indicating that an error occurred during the processing of the message in the service provider's security server and it must be returned to the service client.</p>
</li>
</ol>
<p>If the content-type of the response is <code>text/xml</code> then an error occurred at the service provider's security server and the received SOAP Fault must be returned to the service client. In case of any other content-type, the response is malformed and a corresponding SOAP Fault must be returned to the service client.</p>
<ol start="7">
<li>
<p>Verify the response message using the stored message hash, attachment hashes, and signature in accordance with [<a href="#Ref_PR-SIGDOC">PR-SIGDOC</a>, <a href="#Ref_BATCH-TS">BATCH-TS</a>].</p>
</li>
<li>
<p>Send the service provider's REST response, encapsulated response SOAP message, or a SOAP message package in case the response has attachments to the service client.</p>
<p>a) For REST responses, response HTTP headers are copied from <code>application/x-road-rest-response</code></p>
</li>
</ol>
<p><a id="Messtransport_protocol_message_processing_client"></a>
<a target="_blank" rel="noopener noreferrer" href="img/pr-messtransport-protocol-message-processing-client.svg"><img src="img/pr-messtransport-protocol-message-processing-client.svg" alt="" style="max-width: 100%;"></a></p>
<p>Figure 5. Message processing on service client's side</p>
<div class="markdown-heading"><h3 class="heading-element">3.3 Message Handling in Service Provider's Security Server</h3><a id="33-message-handling-in-service-providers-security-server" class="anchor" aria-label="Permalink: 3.3 Message Handling in Service Provider's Security Server" href="#33-message-handling-in-service-providers-security-server"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>The following describes the actions that the service provider's security server must take in order to perform a secure message exchange between a service client and a service provider.</p>
<ol>
<li>
<p>Establish TLS connection with the service client's security server (see <a href="#21-tls-authentication">Section 2.1</a>).</p>
</li>
<li>
<p>Start reading the X-Road transport message from the service client's security server (message format described in <a href="#31-x-road-transport-message">Section 3.1</a>).</p>
</li>
<li>
<p>The content-type of the request message must be <code>multipart/mixed</code>. The security server must process the message parts as follows:</p>
<p>a) Read all the parts with content-type <code>application/ocsp-response</code>. These parts contain OCSP responses that must be used in when verifying the authentication certificate chain of the service client's security server.</p>
<p>b) The part that comes after OCSP responses must be either a SOAP or REST request</p>
<p>c) SOAP request is identified by content-type <code>text/xml</code> or <code>application/xop+xml</code></p>
<ol>
<li>
<p>If content-type is <code>text/xml</code>, this part contains a regular SOAP request. If content-type is <code>application/xop+xml</code> this part contains the encapsulated SOAP request message for a MTOM-encoded SOAP message package. The message is not forwarded to the service provider until it can be verified.</p>
</li>
<li>
<p>If the content-type of the next part is <code>multipart/mixed</code> then this part is the nested attachments multipart.</p>
</li>
</ol>
<p>d) REST request is identified by content-type <code>application/x-road-rest-request</code></p>
<ol>
<li>
<p>REST request header part has content-type <code>application/x-road-rest-response</code>. This part contains the HTTP request line and HTTP headers.</p>
</li>
<li>
<p>If the content-type of the next part is <code>application/x-road-rest-body</code> then this part is the body of the REST request. For requests without a body, this part does not exist.</p>
</li>
</ol>
<p>d) If the content-type of the next part is <code>application/hash-chain-result</code> then this message contains a batch signature. The hash chain result is stored for message verification.</p>
<p>e) If the content-type of the next part is <code>application/hash-chain</code> then this message contains a batch signature. The hash chain is stored for message verification.</p>
<p>f) If the content-type of the last part is <code>signature/bdoc-1.0/ts</code> then the part contains the signature of the message. If the content-type of the last part is <code>text/xml</code> then the part contains a SOAP fault indicating that an error occurred during the processing of the message in the service client's security server.</p>
</li>
<li>
<p>Verify the request message using the stored message hash, attachment hashes, and signature in accordance with [<a href="#Ref_PR-SIGDOC">PR-SIGDOC</a>, <a href="#Ref_BATCH-TS">BATCH-TS</a>].</p>
</li>
<li>
<p>Either send the encapsulated SOAP message and any attachments to the target service provider, or execute a REST request against target service provider.</p>
</li>
<li>
<p>Start reading a response from the target service provider (message format described in <a href="#Ref_PR-MESS">PR-MESS</a>).</p>
</li>
<li>
<p>Send an X-Road transport message to the service client's security server (message format described in <a href="#31-x-road-transport-message">Section 3.1</a>) in the following steps:</p>
<p>a) Add the following HTTP headers to the HTTP headers of the HTTP request:</p>
<ul>
<li>
<p>Hash algorithm identifier (<code>x-hash-algorithm</code>). The hash algorithm is used by the other party to calculate the hashes of the message parts to be used during message verification.</p>
</li>
<li>
<p>Only in the case of SOAP messages, original content type (<code>x-original-content-type</code>) of the request message.</p>
</li>
</ul>
<p>b) For SOAP messages, write the service provider's response SOAP message (content-type <code>text/xml</code> or <code>application/xop+xml</code> in case the original message is a MTOM-encoded SOAP message package). Calculate the hash of the response SOAP message to be used when creating the signature.</p>
<p>c) If the response from the service provider was a SOAP message package, write a nested MIME multipart (<code>multipart/mixed</code>) containing all attachments as parts. For each part, calculate the hash of the data to be used when creating the signature.</p>
<p>d) For REST messages, write the REST response header part (content-type <code>application/x-road-rest-response</code>). This part contains HTTP status line and HTTP headers. Calculate the hash of the response message to be used when creating the signature.</p>
<ul>
<li>
<p>Some new headers must be added (replaced if one already exists) by the security server, for example <code>x-road-request-id</code></p>
</li>
<li>
<p>Some headers must be removed, for example <code>User-Agent</code></p>
</li>
<li>
<p>All other headers must be copied from original request as-is, for example <code>X-Powered-By</code></p>
</li>
<li>
<p>For details, see [<a href="#Ref_PR-REST">PR-REST</a>] and "Use of HTTP Headers"</p>
</li>
</ul>
<p>e) If the response from the service provider contained a REST message body, write the part containing this (content-type <code>application/x-road-rest-body</code>). Calculate the hash of the body to be used when creating the signature.</p>
<p>f) Calculate the signature using the stored message and attachment hashes in accordance with [<a href="#Ref_PR-SIGDOC">PR-SIGDOC</a>, <a href="#Ref_BATCH-TS">BATCH-TS</a>]. Write the signature as the last part of the message (content-type <code>signature/bdoc-1.0/ts</code>).</p>
</li>
</ol>
<p><a id="Messtransport_protocol_message_processing_service_provider"></a>
<a target="_blank" rel="noopener noreferrer" href="img/pr-messtransport-protocol-message-processing-service-provider.svg"><img src="img/pr-messtransport-protocol-message-processing-service-provider.svg" alt="" style="max-width: 100%;"></a></p>
<p>Figure 6. Message processing on service provider's side</p>
<div class="markdown-heading"><h2 class="heading-element">4 Annex: Example Messages</h2><a id="4-annex-example-messages" class="anchor" aria-label="Permalink: 4 Annex: Example Messages" href="#4-annex-example-messages"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>All the example messages only contain the relevant HTTP headers (content-type) and the headers of the MIME parts. The contents of the MIME parts are omitted for brevity.</p>
<div class="markdown-heading"><h3 class="heading-element">4.1 Response to OCSP Downloading Request</h3><a id="41-response-to-ocsp-downloading-request" class="anchor" aria-label="Permalink: 4.1 Response to OCSP Downloading Request" href="#41-response-to-ocsp-downloading-request"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="highlight highlight-source-httpspec"><pre><span class="pl-s"><span class="pl-v">Content-Type:</span> multipart/related; charset=UTF-8; boundary=jetty625909216ic7gfi1u </span>

<span class="pl-ii">--jetty625909216ic7gfi1u </span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> application/ocsp-response </span>

<span class="pl-ii">...bytes of the ASN.1-encoded OCSP response...</span>
<span class="pl-ii">--jetty625909216ic7gfi1u--</span></pre></div>
<div class="markdown-heading"><h3 class="heading-element">4.2 Simple SOAP Request</h3><a id="42-simple-soap-request" class="anchor" aria-label="Permalink: 4.2 Simple SOAP Request" href="#42-simple-soap-request"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="highlight highlight-source-httpspec"><pre><span class="pl-s"><span class="pl-v">Content-Type:</span> multipart/mixed; charset=UTF-8; boundary=xtop1357783211hcn1yiro </span>

<span class="pl-ii">--xtop1357783211hcn1yiro </span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> application/ocsp-response </span>

<span class="pl-ii">...ocsp response...</span>
<span class="pl-ii">--xtop1357783211hcn1yiro </span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> text/xml ; charset=UTF-8</span>

<span class="pl-ii">...request SOAP...</span>
<span class="pl-ii">--xtop1357783211hcn1yiro </span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> signature/bdoc-1.0/ts </span>

<span class="pl-ii">...signature XML...</span>
<span class="pl-ii">--xtop1357783211hcn1yiro--</span></pre></div>
<div class="markdown-heading"><h3 class="heading-element">4.3 Simple SOAP Response</h3><a id="43-simple-soap-response" class="anchor" aria-label="Permalink: 4.3 Simple SOAP Response" href="#43-simple-soap-response"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="highlight highlight-source-httpspec"><pre><span class="pl-s"><span class="pl-v">Content-Type:</span> multipart/mixed; charset=UTF-8; boundary=xatt569125687hcu8vfma</span>

<span class="pl-ii">--xatt569125687hcu8vfma</span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> text/xml ; charset=UTF-8</span>

<span class="pl-ii">...response SOAP...</span>
<span class="pl-ii">--xatt569125687hcu8vfma</span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> signature/bdoc-1.0/ts </span>

<span class="pl-ii">...signature XML...</span>
<span class="pl-ii">--xatt569125687hcu8vfma--</span></pre></div>
<div class="markdown-heading"><h3 class="heading-element">4.4 SOAP Request with Attachments</h3><a id="44-soap-request-with-attachments" class="anchor" aria-label="Permalink: 4.4 SOAP Request with Attachments" href="#44-soap-request-with-attachments"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="highlight highlight-source-httpspec"><pre><span class="pl-s"><span class="pl-v">Content-Type:</span> multipart/mixed; charset=UTF-8; boundary=xtop1357783211hcn1yiro</span>
 
<span class="pl-ii">--xtop1357783211hcn1yiro </span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> application/ocsp-response </span>

<span class="pl-ii">...ocsp response...</span>
<span class="pl-ii">--xtop1357783211hcn1yiro</span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> text/xml; charset=UTF-8</span>

<span class="pl-ii">...request SOAP...</span>
<span class="pl-ii">--xtop1357783211hcn1yiro </span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> multipart/mixed; charset=UTF-8; boundary=xtop569125687h3h10du0 </span>

<span class="pl-ii">--xtop569125687h3h10du0</span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> text/plain; charset=UTF-8</span>
<span class="pl-s"><span class="pl-v">Content-Location:</span> attachment.txt</span>
 
<span class="pl-ii">...attachment data...</span>
<span class="pl-ii">--xtop569125687h3h10du0 </span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> application/octet-stream</span>
<span class="pl-s"><span class="pl-v">Content-Transfer-Encoding:</span> base64</span>
<span class="pl-s"><span class="pl-v">Content-Id:</span> &lt;data.bin&gt;</span>

<span class="pl-ii">...attachment data...</span>
<span class="pl-ii">--xtop569125687h3h10du0 --</span>

<span class="pl-ii">--xtop1357783211hcn1yiro </span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> application/hash-chain-result</span>

<span class="pl-ii">...hash chain result XML...</span>
<span class="pl-ii">--xtop1357783211hcn1yiro </span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> application/hash-chain</span>

<span class="pl-ii">...hash chain XML...</span>
<span class="pl-ii">--xtop1357783211hcn1yiro </span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> signature/bdoc-1.0/ts </span>

<span class="pl-ii">...signature XML...</span>
<span class="pl-ii">--xtop1357783211hcn1yiro--</span></pre></div>
<div class="markdown-heading"><h3 class="heading-element">4.5 SOAP Response with Fault as Last Part</h3><a id="45-soap-response-with-fault-as-last-part" class="anchor" aria-label="Permalink: 4.5 SOAP Response with Fault as Last Part" href="#45-soap-response-with-fault-as-last-part"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="highlight highlight-source-httpspec"><pre><span class="pl-s"><span class="pl-v">Content-Type:</span> multipart/mixed; charset=UTF-8; boundary=xatt569125687hcu8vfma</span>

<span class="pl-ii">--xatt569125687hcu8vfma</span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> text/xml; charset=UTF-8</span>

<span class="pl-ii">...response SOAP...</span>
<span class="pl-ii">--xatt569125687hcu8vfma</span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> text/xml; charset=UTF-8</span>

<span class="pl-ii">...SOAP fault...</span>
<span class="pl-ii">--xatt569125687hcu8vfma--</span></pre></div>
<div class="markdown-heading"><h3 class="heading-element">4.6 REST Request</h3><a id="46-rest-request" class="anchor" aria-label="Permalink: 4.6 REST Request" href="#46-rest-request"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="highlight highlight-source-httpspec"><pre><span class="pl-s"><span class="pl-v">Content-Type:</span> multipart/mixed; charset=UTF-8; boundary=xtopVuvPTiuLRQanuYKzamfNZBOlxZclEe</span>

<span class="pl-ii">--xtopVuvPTiuLRQanuYKzamfNZBOlxZclEe</span>
<span class="pl-s"><span class="pl-v">content-type:</span> application/ocsp-response</span>

<span class="pl-ii">...ocsp response...</span>
<span class="pl-ii">--xtopVuvPTiuLRQanuYKzamfNZBOlxZclEe</span>
<span class="pl-s"><span class="pl-v">content-type:</span> application/x-road-rest-request</span>

<span class="pl-ii">...REST request header...</span>
<span class="pl-ii">--xtopVuvPTiuLRQanuYKzamfNZBOlxZclEe</span>
<span class="pl-s"><span class="pl-v">content-type:</span> application/x-road-rest-body</span>

<span class="pl-ii">...REST request body...</span>
<span class="pl-ii">--xtopVuvPTiuLRQanuYKzamfNZBOlxZclEe</span>
<span class="pl-s"><span class="pl-v">content-type:</span> application/hash-chain-result</span>

<span class="pl-ii">...hash chain result XML...</span>
<span class="pl-ii">--xtopVuvPTiuLRQanuYKzamfNZBOlxZclEe</span>
<span class="pl-s"><span class="pl-v">content-type:</span> application/hash-chain</span>

<span class="pl-ii">...hash chain XML...</span>
<span class="pl-ii">--xtopVuvPTiuLRQanuYKzamfNZBOlxZclEe</span>
<span class="pl-s"><span class="pl-v">content-type:</span> signature/bdoc-1.0/ts</span>

<span class="pl-ii">...signature XML...</span>
<span class="pl-ii">--xtopVuvPTiuLRQanuYKzamfNZBOlxZclEe--</span></pre></div>
<div class="markdown-heading"><h3 class="heading-element">4.7 REST Response</h3><a id="47-rest-response" class="anchor" aria-label="Permalink: 4.7 REST Response" href="#47-rest-response"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="highlight highlight-source-httpspec"><pre><span class="pl-s"><span class="pl-v">Content-Type:</span> multipart/mixed; charset=UTF-8; boundary=xtoptrgBinKkBvoijBRQYWabkZvkECcuIH</span>

<span class="pl-ii">--xtoptrgBinKkBvoijBRQYWabkZvkECcuIH</span>
<span class="pl-s"><span class="pl-v">content-type:</span> application/x-road-rest-response</span>

<span class="pl-ii">...REST response header...</span>
<span class="pl-ii">--xtoptrgBinKkBvoijBRQYWabkZvkECcuIH</span>
<span class="pl-s"><span class="pl-v">content-type:</span> application/x-road-rest-body</span>

<span class="pl-ii">...REST response body...</span>
<span class="pl-ii">--xtoptrgBinKkBvoijBRQYWabkZvkECcuIH</span>
<span class="pl-s"><span class="pl-v">content-type:</span> application/hash-chain-result</span>

<span class="pl-ii">...hash chain result XML...</span>
<span class="pl-ii">--xtoptrgBinKkBvoijBRQYWabkZvkECcuIH</span>
<span class="pl-s"><span class="pl-v">content-type:</span> application/hash-chain</span>

<span class="pl-ii">...hash chain XML...</span>
<span class="pl-ii">--xtoptrgBinKkBvoijBRQYWabkZvkECcuIH</span>
<span class="pl-s"><span class="pl-v">content-type:</span> signature/bdoc-1.0/ts</span>

<span class="pl-ii">...signature XML...</span>
<span class="pl-ii">--xtoptrgBinKkBvoijBRQYWabkZvkECcuIH--</span></pre></div>
    </article>
  </body>
</html>
