<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="github-markdown.css">
    <style>
      .markdown-body {
        box-sizing: border-box;
        min-width: 200px;
        max-width: 980px;
        margin: 0 auto;
        padding: 45px;
      }
    </style>
    <title>X-Road: Security Server Installation Guide</title>
  </head>
  <body>
    <article class="markdown-body">
<table>
<thead>
<tr>
<th align="right"><a href="img/eu_regional_development_fund_horizontal_div_15.png" target="_blank" rel="noopener noreferrer"><img src="img/eu_regional_development_fund_horizontal_div_15.png" alt="European Union / European Regional Development Fund / Investing in your future" title="Documents that are tagged with EU/SF logos must keep the logos until 1.1.2022, if it has not stated otherwise in the documentation. If new documentation is created  using EU/SF resources the logos must be tagged appropriately so that the deadline for logos could be found." style="max-width:100%;"></a></th>
</tr>
</thead>
</table>
<h1>
<a id="security-server-installation-guide-for-ubuntu-" class="anchor" href="#security-server-installation-guide-for-ubuntu-" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Security Server Installation Guide for Ubuntu </h1>
<p><strong>X-ROAD 6</strong></p>
<p>Version: 2.19<br>
Doc. ID: IG-SS</p>
<hr>
<h2>
<a id="version-history-" class="anchor" href="#version-history-" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Version history </h2>
<table>
<thead>
<tr>
<th>Date</th>
<th>Version</th>
<th>Description</th>
<th>Author</th>
</tr>
</thead>
<tbody>
<tr>
<td>01.12.2014</td>
<td>1.0</td>
<td>Initial version</td>
<td></td>
</tr>
<tr>
<td>19.01.2015</td>
<td>1.1</td>
<td>License information added</td>
<td></td>
</tr>
<tr>
<td>18.03.2015</td>
<td>1.2</td>
<td>Meta-package for security server added. Legacy securelog module removed</td>
<td></td>
</tr>
<tr>
<td>02.04.2015</td>
<td>1.3</td>
<td>“sdsb” change to “xroad”</td>
<td></td>
</tr>
<tr>
<td>27.05.2015</td>
<td>1.4</td>
<td>Some typos fixed</td>
<td></td>
</tr>
<tr>
<td>30.06.2015</td>
<td>1.5</td>
<td>Minor corrections done</td>
<td></td>
</tr>
<tr>
<td>06.07.2015</td>
<td>1.6</td>
<td>New repository address</td>
<td></td>
</tr>
<tr>
<td>18.09.2015</td>
<td>1.7</td>
<td>Reference data in <a href="#32-reference-data">3.2</a> updated</td>
<td></td>
</tr>
<tr>
<td>18.09.2015</td>
<td>2.0</td>
<td>Editorial changes made</td>
<td></td>
</tr>
<tr>
<td>13.10.2015</td>
<td>2.1</td>
<td>Editorial changes made</td>
<td></td>
</tr>
<tr>
<td>10.12.2015</td>
<td>2.2</td>
<td>Updated the installing of the support for hardware tokens (<a href="#27-installing-the-support-for-hardware-tokens">2.7</a>)</td>
<td></td>
</tr>
<tr>
<td>17.12.2015</td>
<td>2.3</td>
<td>Added <em>xroad-addon-wsdlvalidator</em> package</td>
<td></td>
</tr>
<tr>
<td>19.05.2016</td>
<td>2.4</td>
<td>Merged changes from xtee6-doc repo. Updated table <a href="#22-reference-data">2.2</a> with p 1.12, added chapter <a href="#28-installing-support-for-monitoring">2.8</a> and updated <a href="#32-reference-data">3.2</a>.</td>
<td></td>
</tr>
<tr>
<td>30.09.2016</td>
<td>2.5</td>
<td>Added chapter „<a href="#45-different-versions-of-xroad--packages-after-successful-upgrade">Different versions of xroad-* package after successful upgrade</a>“.</td>
<td></td>
</tr>
<tr>
<td>07.12.2016</td>
<td>2.6</td>
<td>Added operational data monitoring packages. 2 GB RAM -&gt; 3 GB RAM</td>
<td></td>
</tr>
<tr>
<td>23.02.2017</td>
<td>2.7</td>
<td>Converted to Github flavoured Markdown, added license text, adjusted tables for better output in PDF</td>
<td>Toomas Mölder</td>
</tr>
<tr>
<td>13.04.2017</td>
<td>2.8</td>
<td>Added token ID formatting</td>
<td>Cybernetica AS</td>
</tr>
<tr>
<td>22.01.2018</td>
<td>2.8.1</td>
<td>Added NEE and NGO member classes</td>
<td>Jürgen Šuvalov</td>
</tr>
<tr>
<td>25.08.2017</td>
<td>2.9</td>
<td>Update environmental monitoring installation information</td>
<td>Ilkka Seppälä</td>
</tr>
<tr>
<td>15.09.2017</td>
<td>2.10</td>
<td>Added package with configuration specific to Estonia xroad-securityserver-ee</td>
<td>Cybernetica AS</td>
</tr>
<tr>
<td>05.03.2018</td>
<td>2.11</td>
<td>Added terms and abbreviations reference and document links</td>
<td>Tatu Repo</td>
</tr>
<tr>
<td>10.04.2018</td>
<td>2.12</td>
<td>Updated chapter "<a href="#27-installing-the-support-for-hardware-tokens">Installing the Support for Hardware Tokens</a>" with configurable parameters described in the configuration file 'devices.ini'</td>
<td>Cybernetica AS</td>
</tr>
<tr>
<td>07.06.2018</td>
<td>2.12.1</td>
<td>Updated repository information with x-tee.ee domain</td>
<td>Jürgen Šuvalov</td>
</tr>
<tr>
<td>03.07.2018</td>
<td>2.12.2</td>
<td>Added network diagram and reference data for monitoring servers</td>
<td>Jürgen Šuvalov</td>
</tr>
<tr>
<td>08.08.2018</td>
<td>2.12.3</td>
<td>Editorial changes</td>
<td>Jan Raik</td>
</tr>
<tr>
<td>13.08.2018</td>
<td>2.12.4</td>
<td>Package name fix</td>
<td>Taavi Meinberg</td>
</tr>
<tr>
<td>14.10.2018</td>
<td>2.13</td>
<td>Update package repository address</td>
<td>Petteri Kivimäki</td>
</tr>
<tr>
<td>25.10.2018</td>
<td>2.14</td>
<td>Add RHEL7 as supported platform, update section 2.2 Reference data</td>
<td>Petteri Kivimäki</td>
</tr>
<tr>
<td>15.11.2018</td>
<td>2.15</td>
<td>Add Ubuntu 18 installation instructions</td>
<td>Jarkko Hyöty</td>
</tr>
<tr>
<td>12.12.2018</td>
<td>2.12.5</td>
<td>Added managment security servers' IPs</td>
<td>Jan Raik</td>
</tr>
<tr>
<td>03.01.2019</td>
<td>2.12.6</td>
<td>Updated repository key</td>
<td>Jan Raik</td>
</tr>
<tr>
<td>28.01.2019</td>
<td>2.16</td>
<td>Update port 2080 documentation</td>
<td>Petteri Kivimäki</td>
</tr>
<tr>
<td>30.05.2019</td>
<td>2.17</td>
<td>Added package installation instructions on chapter "<a href="#24-preparing-os">2.4 Preparing OS</a>"</td>
<td>Raul Martinez</td>
</tr>
<tr>
<td>11.09.2019</td>
<td>2.18</td>
<td>Remove Ubuntu 14.04 from supported platforms</td>
<td>Jarkko Hyöty</td>
</tr>
<tr>
<td>20.09.2019</td>
<td>2.19</td>
<td>Add instructions for using remote databases</td>
<td>Ilkka Seppälä</td>
</tr>
</tbody>
</table>
<h2>
<a id="table-of-contents-" class="anchor" href="#table-of-contents-" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Table of Contents </h2>

<ul>
<li><a href="#license">License</a></li>
<li>
<a href="#1-introduction">1 Introduction</a>
<ul>
<li><a href="#11-target-audience">1.1 Target Audience</a></li>
<li><a href="#12-terms-and-abbreviations">1.2 Terms and abbreviations</a></li>
<li><a href="#13-references">1.3 References</a></li>
</ul>
</li>
<li>
<a href="#2-installation">2 Installation</a>
<ul>
<li><a href="#21-supported-platforms">2.1 Supported Platforms</a></li>
<li><a href="#22-reference-data">2.2 Reference Data</a></li>
<li>
<a href="#23-network-diagram">2.3 Network Diagram</a>
<ul>
<li><a href="#231-ria-ips-for-whitelisting">2.3.1 RIA IP's for Whitelisting</a></li>
</ul>
</li>
<li><a href="#24-requirements-for-the-security-server">2.4 Requirements for the Security Server</a></li>
<li><a href="#25-preparing-os">2.5 Preparing OS</a></li>
<li><a href="#26-installation">2.6 Installation</a></li>
<li><a href="#27-post-installation-checks">2.7 Post-Installation Checks</a></li>
<li><a href="#28-installing-the-support-for-hardware-tokens">2.8 Installing the Support for Hardware Tokens</a></li>
<li><a href="#29-installing-the-support-for-environmental-monitoring">2.9 Installing the Support for Environmental Monitoring</a></li>
<li><a href="#210-remote-database-post-installation-tasks">2.10 Remote Database Post-Installation Tasks</a></li>
</ul>
</li>
<li>
<a href="#3-security-server-initial-configuration">3 Security Server Initial Configuration</a>
<ul>
<li><a href="#31-prerequisites">3.1 Prerequisites</a></li>
<li><a href="#32-reference-data">3.2 Reference Data</a></li>
<li><a href="#33-configuration">3.3 Configuration</a></li>
</ul>
</li>
<li>
<a href="#4-installation-error-handling">4 Installation Error handling</a>
<ul>
<li><a href="#41-cannot-set-lc_all-to-default-locale">4.1 Cannot Set LC_ALL to Default Locale</a></li>
<li><a href="#42-postgresql-is-not-utf8-compatible">4.2 PostgreSQL Is Not UTF8 Compatible</a></li>
<li><a href="#43-could-not-create-default-cluster">4.3 Could Not Create Default Cluster</a></li>
<li><a href="#44-is-postgres-running-on-port-5432">4.4 Is Postgres Running On Port 5432?</a></li>
<li><a href="#45-different-versions-of-xroad--packages-after-successful-upgrade">4.5 Different versions of xroad-* packages after successful upgrade</a></li>
</ul>
</li>
</ul>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>License</h2>
<p>This document is licensed under the Creative Commons Attribution-ShareAlike 3.0 Unported License. To view a copy of this license, visit <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="nofollow">http://creativecommons.org/licenses/by-sa/3.0/</a></p>
<h2>
<a id="1-introduction" class="anchor" href="#1-introduction" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1 Introduction</h2>
<h3>
<a id="11-target-audience" class="anchor" href="#11-target-audience" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1.1 Target Audience</h3>
<p>The intended audience of this Installation Guide are X-Road Security server system administrators responsible for installing and using X-Road software. The daily operation and maintenance of the security server is covered by its User Guide [<a href="#Ref_UG-SS">UG-SS</a>].</p>
<p>The document is intended for readers with a moderate knowledge of Linux server management, computer networks, and the X-Road working principles.</p>
<h3>
<a id="12-terms-and-abbreviations" class="anchor" href="#12-terms-and-abbreviations" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1.2 Terms and abbreviations</h3>
<p>See X-Road terms and abbreviations documentation [<a href="#Ref_TERMS">TA-TERMS</a>].</p>
<h3>
<a id="13-references" class="anchor" href="#13-references" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1.3 References</h3>
<ol>
<li>
<p><a id="Ref_UG-SS"></a>[UG-SS] Cybernetica AS. X-Road 6. Security Server User Guide. Document ID: <a href="ug-ss_x-road_6_security_server_user_guide.html">UG-SS</a></p>
</li>
<li>
<p><a id="Ref_TERMS"></a>[TA-TERMS] X-Road Terms and Abbreviations. Document ID: <a href="terms_x-road_docs.html">TA-TERMS</a>.</p>
</li>
</ol>
<h2>
<a id="2-installation" class="anchor" href="#2-installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2 Installation</h2>
<h3>
<a id="21-supported-platforms" class="anchor" href="#21-supported-platforms" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.1 Supported Platforms</h3>
<p>The security server runs on the *Ubuntu Server 18.04 Long-Term Support (LTS) operating system on a 64-bit platform. The Estonian version of the security server software is distributed as .deb packages through the official X-tee repository at <a href="http://x-tee.ee/packages/" rel="nofollow">http://x-tee.ee/packages/</a>.</p>
<p>The software can be installed both on physical and virtualized hardware (of the latter, Xen and Oracle VirtualBox have been tested).</p>
<h3>
<a id="22-reference-data" class="anchor" href="#22-reference-data" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.2 Reference Data</h3>
<p><em>Note</em>: The information in empty cells should be determined before the server’s installation, by the person performing the installation.</p>
<p><strong>Caution</strong>: Data necessary for the functioning of the operating system is not included.</p>
<table>
<thead>
<tr>
<th><strong>Ref</strong></th>
<th></th>
<th><strong>Explanation</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>1.0</td>
<td>Ubuntu 18.04, 64-bit<br>3 GB RAM, 3 GB free disk space</td>
<td>Minimum requirements</td>
</tr>
<tr>
<td>1.1</td>
<td><a href="http://x-tee.ee/packages/live/xroad" rel="nofollow">http://x-tee.ee/packages/live/xroad</a></td>
<td>X-Road stable package repository</td>
</tr>
<tr>
<td> </td>
<td><a href="http://x-tee.ee/packages/test/xroad" rel="nofollow">http://x-tee.ee/packages/test/xroad</a></td>
<td>X-Road test package repository</td>
</tr>
<tr>
<td>1.2</td>
<td><a href="https://x-tee.ee/packages/xroad_repo.gpg" rel="nofollow">https://x-tee.ee/packages/xroad_repo.gpg</a></td>
<td>The repository key</td>
</tr>
<tr>
<td>1.3</td>
<td></td>
<td>Account name in the user interface</td>
</tr>
<tr>
<td>1.4</td>
<td><strong>INBOUND PORTS FROM EXTERNAL NETWORK</strong></td>
<td>Ports for inbound connections (from the external network to the security server)</td>
</tr>
<tr>
<td> </td>
<td>TCP 5500</td>
<td>Message exchange between security servers. Recommended to use IP filtering (<strong>whitelisting only <a href="#231-ria-ips-for-whitelisting">RIA IP's</a> and partners</strong>).</td>
</tr>
<tr>
<td> </td>
<td>TCP 5577</td>
<td>Querying of OCSP responses between security servers. Recommended to use IP filtering (<strong>whitelisting only <a href="#231-ria-ips-for-whitelisting">RIA IP's</a> and partners</strong>)</td>
</tr>
<tr>
<td>1.5</td>
<td><strong>OUTBOUND PORTS TO EXTERNAL NETWORK</strong></td>
<td>Ports for outbound connections (from the security server to the external network)</td>
</tr>
<tr>
<td> </td>
<td>TCP 5500</td>
<td>Message exchange between security servers</td>
</tr>
<tr>
<td> </td>
<td>TCP 5577</td>
<td>Querying of OCSP responses between security servers</td>
</tr>
<tr>
<td> </td>
<td>TCP 4001</td>
<td>Communication with the central server</td>
</tr>
<tr>
<td> </td>
<td>TCP 80</td>
<td>Downloading global configuration from central server.</td>
</tr>
<tr>
<td> </td>
<td>TCP 80,443</td>
<td>Most common OCSP and time-stamping services.</td>
</tr>
<tr>
<td>1.6</td>
<td><strong>INBOUND PORTS FROM INTERNAL NETWORK</strong></td>
<td>Ports for inbound connections (from the internal network to the security server)</td>
</tr>
<tr>
<td> </td>
<td>TCP 4000</td>
<td>User interface (local network). <strong>Must not be accessible from the Internet!</strong>
</td>
</tr>
<tr>
<td> </td>
<td>TCP 80, 443</td>
<td>Information system access points (in the local network)<br> <strong>Must not be accessible from the Internet without strong authentication and Recommended to use IP filtering.</strong>
</td>
</tr>
<tr>
<td> </td>
<td>TCP 9011</td>
<td>Operational data monitoring daemon JMX listening port</td>
</tr>
<tr>
<td> </td>
<td>TCP 9999</td>
<td>Environmental monitoring daemon JMX listening port</td>
</tr>
<tr>
<td>1.7</td>
<td><strong>OUTBOUND PORTS TO INTERNAL NETWORK</strong></td>
<td>Ports for outbound connections (from the security server to the internal network)</td>
</tr>
<tr>
<td> </td>
<td>TCP 80, 443</td>
<td>Producer information system endpoints</td>
</tr>
<tr>
<td> </td>
<td>TCP 2080</td>
<td>Message exchange between security server and operational data monitoring daemon (by default on localhost)</td>
</tr>
<tr>
<td>1.8</td>
<td></td>
<td>Security server internal IP address(es) and hostname(s)</td>
</tr>
<tr>
<td>1.9</td>
<td></td>
<td>Security server public IP address, NAT address</td>
</tr>
<tr>
<td>1.10</td>
<td>&lt;by default, the server’s IP addresses and names are added to the certificate’s Distinguished Name (DN) field&gt;</td>
<td>Information about the user interface TLS certificate</td>
</tr>
<tr>
<td>1.11</td>
<td>&lt;by default, the server’s IP addresses and names are added to the certificate’s Distinguished Name (DN) field&gt;</td>
<td>Information about the services TLS certificate</td>
</tr>
</tbody>
</table>
<h3>
<a id="23-network-diagram" class="anchor" href="#23-network-diagram" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.3 Network Diagram</h3>
<p>The following network diagram is an example of a simple stand-alone Security Server setup. Attention should be paid when configuring the firewall of your Security Server, as misconfigurations (e.g. exposing port 80/tcp to the public internet) can leave your server vulnerable. <strong>IP whitelisting is recommended for all ports.</strong></p>
<p>Allowing incoming connections from the Monitoring Security Server on ports 5500/tcp and 5577/tcp (<a href="#231-ria-ips-for-whitelisting">monitoring server IP's</a>) is necessary for the X-Road Center to be able to monitor the ecosystem and provide statistics and support for Members.</p>
<p><strong>Caution</strong>: The enabling of auxiliary services which are necessary for the functioning and management of the operating system (such as DNS, NTP, and SSH) stay outside the scope of this guide.</p>
<p><a href="img/ig-ss_network_diagram.png" target="_blank" rel="noopener noreferrer"><img src="img/ig-ss_network_diagram.png" alt="network diagram" style="max-width:100%;"></a></p>
<h4>
<a id="231-ria-ips-for-whitelisting" class="anchor" href="#231-ria-ips-for-whitelisting" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.3.1 RIA IP's for Whitelisting</h4>
<table>
<thead>
<tr>
<th>Type</th>
<th><strong>EE - production</strong></th>
<th><strong>ee-test</strong></th>
<th><strong>ee-dev</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Central Server</td>
<td>213.184.41.178 <br> 213.184.41.186 <br> 213.184.41.190</td>
<td>195.80.127.40 <br> 195.80.127.43</td>
<td>195.80.109.140</td>
</tr>
<tr>
<td>Central Monitoring Server</td>
<td>195.80.123.159</td>
<td>195.80.123.164</td>
<td>195.80.123.169</td>
</tr>
<tr>
<td>Management Security Server</td>
<td>213.184.41.177 <br> 213.184.41.185 <br> 213.184.41.189</td>
<td>195.80.127.37</td>
<td>195.80.109.139</td>
</tr>
</tbody>
</table>
<h3>
<a id="24-requirements-for-the-security-server" class="anchor" href="#24-requirements-for-the-security-server" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.4 Requirements for the Security Server</h3>
<p>Minimum recommended hardware parameters:</p>
<ul>
<li>
<p>the server’s hardware (motherboard, CPU, network interface cards, storage system) must be supported by Ubuntu 18.04 in general;</p>
</li>
<li>
<p>a 64-bit dual-core Intel, AMD or compatible CPU; AES instruction set support is highly recommended;</p>
</li>
<li>
<p>3 GB RAM;</p>
</li>
<li>
<p>a 100 Mbps network interface card;</p>
</li>
<li>
<p>if necessary, interfaces for the use of hardware tokens.</p>
</li>
</ul>
<p>Requirements to software and settings:</p>
<ul>
<li>
<p>an installed and configured Ubuntu 18.04 LTS x86-64 operating system;</p>
</li>
<li>
<p>if the security server is separated from other networks by a firewall and/or NAT, the necessary connections to and from the security server are allowed (<strong>reference data: 1.4; 1.5; 1.6; 1.7; 1.12</strong>). The enabling of auxiliary services which are necessary for the functioning and management of the operating system (such as DNS, NTP, and SSH) stay outside the scope of this guide;</p>
</li>
<li>
<p>if the security server has a private IP address, a corresponding NAT record must be created in the firewall (<strong>reference data: 1.9</strong>).</p>
</li>
</ul>
<h3>
<a id="25-preparing-os" class="anchor" href="#25-preparing-os" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.5 Preparing OS</h3>
<ul>
<li>
<p>Add system user (<strong>reference data: 1.3</strong>) whom all roles in the user interface are granted to. Add a new user with the command</p>
<pre><code>sudo adduser &lt;username&gt;
</code></pre>
<p>User roles are discussed in detail in X-Road Security Server User Guide [<a href="#Ref_UG-SS">UG-SS</a>].</p>
</li>
<li>
<p>Set the operating system locale. Add following line to the <code>/etc/environment</code> file.</p>
<pre><code>LC_ALL=en_US.UTF-8
</code></pre>
</li>
<li>
<p>Ensure that the packages <code>locales</code> and <code>software-properties-common</code> are present</p>
<pre><code>sudo apt-get install locales software-properties-common
</code></pre>
</li>
<li>
<p>Ensure that the locale is available</p>
<pre><code>sudo locale-gen en_US.UTF-8
</code></pre>
</li>
</ul>
<h3>
<a id="26-installation" class="anchor" href="#26-installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.6 Installation</h3>
<p>To install the X-Road security server software, follow these steps.</p>
<ol>
<li>
<p>Add to <code>/etc/apt/sources.list.d/xroad.list</code> the address of X-Road package repository (<strong>reference data: 1.1</strong>) and the nginx repository:</p>
<pre><code>deb http://x-tee.ee/packages/live/xroad bionic main
</code></pre>
</li>
<li>
<p>Add the X-Road repository’s signing key to the list of trusted keys (<strong>reference data: 1.2</strong>):</p>
<pre><code>curl http://x-tee.ee/packages/live/xroad/repo.gpg | sudo apt-key add -
</code></pre>
</li>
<li>
<p>(Optional step) If you want to use remote database server instead of the default locally installed one, you need to pre-create a configuration file containing the database administrator master password. This can be done by performing the following steps:</p>
<pre><code> sudo touch /etc/xroad.properties
 sudo chown root:root /etc/xroad.properties
 sudo chmod 600 /etc/xroad.properties
</code></pre>
<p>Edit <code>/etc/xroad.properties</code> contents. See the example below. Replace parameter values with your own.</p>
<pre><code> postgres.connection.password = 54F46A19E50C11DA8631468CF09BE5DB
</code></pre>
</li>
<li>
<p>Issue the following commands to install the security server packages (use package xroad-securityserver-ee to include configuration specific to Estonia; use package xroad-securityserver-fi to include configuration specific to Finland):</p>
<pre><code>sudo apt-get update
sudo apt-get install postgresql
sudo apt-get install xroad-securityserver-ee
</code></pre>
</li>
</ol>
<p>Upon the first installation of the packages, the system asks for the following information.</p>
<ul>
<li>
<p>Account name for the user who will be granted the rights to perform all activities in the user interface (<strong>reference data: 1.3</strong>).</p>
</li>
<li>
<p>Database server URL. Locally installed database is suggested as default but remote databases can be used as well. In case remote database is used, one should verify that the version of the local PostgreSQL client matches the version of the remote PostgreSQL server.</p>
</li>
<li>
<p>The Distinguished Name of the owner of the <strong>user interface’s</strong> self-signed TLS certificate (<em>Subject DN</em>) and its alternative names (<em>subjectAltName</em>) (<strong>reference data: 1.8; 1.10</strong>). The certificate is used for securing connections to the user interface.
The name and IP addresses detected from the operating system are suggested as default values.</p>
<ul>
<li>
<p>The <em>Subject DN</em> must be entered in the format:</p>
<pre><code>/CN=server.domain.tld
</code></pre>
</li>
<li>
<p>All IP addresses and domain names in use must be entered as alternative names in the format:</p>
<pre><code>IP:1.2.3.4,IP:4.3.2.1,DNS:servername,DNS:servername2.domain.tld
</code></pre>
</li>
</ul>
</li>
<li>
<p>The Distinguished Name of the owner of the TLS certificate that is used for securing the HTTPS access point of information systems (<strong>reference data: 1.8; 1.11</strong>).
The name and IP addresses detected from the system are suggested as default values.</p>
<ul>
<li>
<p>The <em>Subject DN</em> must be entered in the format:</p>
<pre><code>/CN=server.domain.tld
</code></pre>
</li>
<li>
<p>All IP addresses and domain names in use must be entered as alternative names in the format:</p>
<pre><code>IP:1.2.3.4,IP:4.3.2.1,DNS:servername,DNS:servername2.domain.tld
</code></pre>
</li>
</ul>
</li>
</ul>
<p>The meta-package <code>xroad-securityserver-ee</code> also installs metaservices module <code>xroad-addon-metaservices</code>, messagelog module <code>xroad-addon-messagelog</code>, operational data monitoring modules <code>xroad-addon-opmonitoring</code>, <code>xroad-opmonitor</code> and WSDL validator module <code>xroad-addon-wsdlvalidator</code>.</p>
<h3>
<a id="27-post-installation-checks" class="anchor" href="#27-post-installation-checks" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.7 Post-Installation Checks</h3>
<p>The installation is successful if system services are started and the user interface is responding.</p>
<ul>
<li>
<p>Ensure from the command line that X-Road services are in the <code>running</code> state (example output follows):</p>
<ul>
<li>Ubuntu 18.04
<pre><code>sudo systemctl list-units "xroad*"

UNIT                     LOAD   ACTIVE SUB     DESCRIPTION
xroad-confclient.service loaded active running X-Road confclient
xroad-jetty.service      loaded active running X-Road Jetty server
xroad-monitor.service    loaded active running X-Road Monitor
xroad-opmonitor.service loaded active running X-Road opmonitor daemon
xroad-proxy.service      loaded active running X-Road Proxy
xroad-signer.service     loaded active running X-Road signer
</code></pre>
</li>
</ul>
</li>
<li>
<p>Ensure that the security server user interface at <a href="https://SECURITYSERVER:4000/" rel="nofollow">https://SECURITYSERVER:4000/</a> (<strong>reference data: 1.8; 1.6</strong>) can be opened in a Web browser. To log in, use the account name chosen during the installation (<strong>reference data: 1.3</strong>). While the user interface is still starting up, the Web browser may display the “502 Bad Gateway” error.</p>
</li>
</ul>
<h3>
<a id="28-installing-the-support-for-hardware-tokens" class="anchor" href="#28-installing-the-support-for-hardware-tokens" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.8 Installing the Support for Hardware Tokens</h3>
<p>To configure support for hardware security tokens (smartcard, USB token, Hardware Security Module), act as follows.</p>
<ol>
<li>
<p>Install the hardware token support module using the following command:</p>
<pre><code>sudo apt-get install xroad-addon-hwtokens
</code></pre>
</li>
<li>
<p>Install and configure a PKCS#11 driver for the hardware token according to the manufacturer's instructions.</p>
</li>
<li>
<p>Add the path to the PKCS#11 driver to the file <code>/etc/xroad/devices.ini</code> (as described in the example given in the file).</p>
</li>
<li>
<p>After installing and configuring the driver, the <code>xroad-signer</code> service must be restarted:</p>
<pre><code>sudo service xroad-signer restart
</code></pre>
</li>
</ol>
<p>If you are running a high availability (HA) hardware token setup (such as a cluster with replicated tokens) then you may need to constrain the token identifier format such that the token replicas can be seen as the same token. The token identifier format can be changed in <code>/etc/xroad/devices.ini</code> via the <code>token_id_format</code> property (default value: <code>{moduleType}{slotIndex}{serialNumber}{label}</code>). Removing certain parts of the identifier will allow the HA setup to work correctly when one of the tokens goes down and is replaced by a replica. For example, if the token replicas are reported to be on different slots the <code>{slotIndex}</code> part should be removed from the identifier format.</p>
<p>Depending on the hardware token there may be a need for more additional configuration. All possible configurable parameters in the <code>/etc/xroad/devices.ini</code> are described in the next table.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Default Value</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>enabled</em></td>
<td>BOOLEAN</td>
<td><em>true</em></td>
<td>Indicates whether this device is enabled.</td>
</tr>
<tr>
<td><em>library</em></td>
<td>STRING</td>
<td></td>
<td>The path to the pkcs#11 library of the device driver.</td>
</tr>
<tr>
<td><em>library_cant_create_os_threads</em></td>
<td>BOOLEAN</td>
<td><em>false</em></td>
<td>Indicates whether application threads, which are executing calls to the pkcs#11 library, may not use native operating system calls to spawn new threads (in other words, the library’s code may not create its own threads).</td>
</tr>
<tr>
<td><em>os_locking_ok</em></td>
<td>BOOLEAN</td>
<td><em>false</em></td>
<td>Indicates whether the pkcs#11 library may use the native operation system threading model for locking.</td>
</tr>
<tr>
<td><em>sign_verify_pin</em></td>
<td>BOOLEAN</td>
<td><em>false</em></td>
<td>Indicates whether the PIN should be entered per signing operation.</td>
</tr>
<tr>
<td><em>token_id_format</em></td>
<td>STRING</td>
<td><em>{moduleType}{slotIndex}{serialNumber}{label}</em></td>
<td>Specifies the identifier format used to uniquely identify a token. In certain high availability setups may need be constrained to support replicated tokens (eg. by removing the slot index part which may be diffirent for the token replicas).</td>
</tr>
<tr>
<td><em>sign_mechanism</em></td>
<td>STRING</td>
<td><em>CKM_RSA_PKCS</em></td>
<td>Specifies the signing mechanism. Supported values: <em>CKM_RSA_PKCS</em>, <em>CKM_RSA_PKCS_PSS</em>.</td>
</tr>
<tr>
<td><em>pub_key_attribute_encrypt</em></td>
<td>BOOLEAN</td>
<td><em>true</em></td>
<td>Indicates whether public key can be used for encryption.</td>
</tr>
<tr>
<td><em>pub_key_attribute_verify</em></td>
<td>BOOLEAN</td>
<td><em>true</em></td>
<td>Indicates whether public key can be used for verification.</td>
</tr>
<tr>
<td><em>pub_key_attribute_wrap</em></td>
<td>BOOLEAN</td>
<td></td>
<td>Indicates whether public key can be used for wrapping other keys.</td>
</tr>
<tr>
<td><em>pub_key_attribute_allowed_mechanisms</em></td>
<td>STRING LIST</td>
<td></td>
<td>Specifies public key allowed mechanisms. Supported values: <em>CKM_RSA_PKCS</em>, <em>CKM_SHA256_RSA_PKCS</em>, <em>CKM_SHA384_RSA_PKCS</em>, <em>CKM_SHA512_RSA_PKCS</em>, and <em>CKM_RSA_PKCS_PSS</em>, <em>CKM_SHA256_RSA_PKCS_PSS</em>, <em>CKM_SHA384_RSA_PKCS_PSS</em>, <em>CKM_SHA512_RSA_PKCS_PSS</em>.</td>
</tr>
<tr>
<td><em>priv_key_attribute_sensitive</em></td>
<td>BOOLEAN</td>
<td><em>true</em></td>
<td>Indicates whether private key is sensitive.</td>
</tr>
<tr>
<td><em>priv_key_attribute_decrypt</em></td>
<td>BOOLEAN</td>
<td><em>true</em></td>
<td>Indicates whether private key can be used for encryption.</td>
</tr>
<tr>
<td><em>priv_key_attribute_sign</em></td>
<td>BOOLEAN</td>
<td><em>true</em></td>
<td>Indicates whether private key can be used for signing.</td>
</tr>
<tr>
<td><em>priv_key_attribute_unwrap</em></td>
<td>BOOLEAN</td>
<td></td>
<td>Indicates whether private key can be used for unwrapping wrapped keys.</td>
</tr>
<tr>
<td><em>priv_key_attribute_allowed_mechanisms</em></td>
<td>STRING LIST</td>
<td></td>
<td>Specifies private key allowed mechanisms. Supported values: <em>CKM_RSA_PKCS</em>, <em>CKM_SHA256_RSA_PKCS</em>, <em>CKM_SHA384_RSA_PKCS</em>, <em>CKM_SHA512_RSA_PKCS</em>, and <em>CKM_RSA_PKCS_PSS</em>, <em>CKM_SHA256_RSA_PKCS_PSS</em>, <em>CKM_SHA384_RSA_PKCS_PSS</em>, <em>CKM_SHA512_RSA_PKCS_PSS</em>.</td>
</tr>
</tbody>
</table>
<p><strong>Note 1:</strong> Only parameter <em>library</em> is mandatory, all the others are optional.<br>
<strong>Note 2:</strong> The item separator of the type STRING LIST is ",".</p>
<h3>
<a id="29-installing-the-support-for-environmental-monitoring" class="anchor" href="#29-installing-the-support-for-environmental-monitoring" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.9 Installing the Support for Environmental Monitoring</h3>
<p>The support for environmental monitoring functionality on a security server is provided by package xroad-monitor that is installed by default. The package installs and starts the <code>xroad-monitor</code> process that will gather and make available the monitoring information.</p>
<h3>
<a id="210-remote-database-post-installation-tasks" class="anchor" href="#210-remote-database-post-installation-tasks" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.10 Remote Database Post-Installation Tasks</h3>
<p>Local PostgreSQL is always installed with Security Server. When remote database host is used, the local PostgreSQL can be stopped and disabled after the installation.</p>
<p>To stop the local PostgreSQL server</p>
<p><code>systemctl stop postgresql</code></p>
<p>To disable the local PostgreSQL server so that it does not start automatically when the server is rebooted.</p>
<p><code>systemctl mask postgresql</code></p>
<h2>
<a id="3-security-server-initial-configuration" class="anchor" href="#3-security-server-initial-configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>3 Security Server Initial Configuration</h2>
<p>During the security server initial configuration, the server’s X-Road membership information and the software token’s PIN are set.</p>
<h3>
<a id="31-prerequisites" class="anchor" href="#31-prerequisites" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>3.1 Prerequisites</h3>
<p>Configuring the security server assumes that the security server owner is a member of the X-Road.</p>
<h3>
<a id="32-reference-data" class="anchor" href="#32-reference-data" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>3.2 Reference Data</h3>
<p>ATTENTION: Reference items 2.1 - 2.3 in the reference data are provided to the security server owner by the X-Road central’s administrator.</p>
<p>The security server code and the software token’s PIN will be determined during the installation at the latest, by the person performing the installation.</p>
<table>
<thead>
<tr>
<th>Ref</th>
<th></th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.1</td>
<td>
<a href="https://x-tee.ee/anchors/" rel="nofollow">https://x-tee.ee/anchors/</a>&lt;anchor file&gt;<br> ee-dev - development environment<br> ee-test - test environment<br> EE - production environment</td>
<td>Global configuration anchor file</td>
</tr>
<tr>
<td>2.2</td>
<td>GOV - government<br> COM - commercial<br> NGO - non-profit<br> NEE - not Estonian</td>
<td>Member class of the security server's owner</td>
</tr>
<tr>
<td>2.3</td>
<td>&lt;security server owner register code&gt;</td>
<td>Member code of the security server's owner</td>
</tr>
<tr>
<td>2.4</td>
<td>&lt;choose security server identificator name&gt;</td>
<td>Security server's code</td>
</tr>
<tr>
<td>2.5</td>
<td>&lt;choose PIN for software token&gt;</td>
<td>Software token’s PIN</td>
</tr>
</tbody>
</table>
<h3>
<a id="33-configuration" class="anchor" href="#33-configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>3.3 Configuration</h3>
<p>To perform the initial configuration, open the address</p>
<pre><code>https://SECURITYSERVER:4000/
</code></pre>
<p>in a Web browser (<strong>reference data: 1.8; 1.6</strong>). To log in, use the account name chosen during the installation (<strong>reference data: 1.3).</strong></p>
<p>Upon first log-in, the system asks for the following information.</p>
<ul>
<li>
<p>The global configuration anchor file (<strong>reference data: 2.1</strong>).</p>
<p><strong>Please verify anchor hash value with the published value.</strong></p>
</li>
</ul>
<p>If the configuration is successfully downloaded, the system asks for the following information.</p>
<ul>
<li>
<p>The security server owner’s member class (<strong>reference data: 2.2</strong>).</p>
</li>
<li>
<p>The security server owner’s member code (<strong>reference data: 2.3</strong>).
If the member class and member code are correctly entered, the system displays the security server owner’s name as registered in the X-Road center.</p>
<ul>
<li>
<p><strong>NB! If the security server owner  or hosted client is a foreign organization (not Estonian), then the "NEE" Member Class must be selected in the security server.</strong></p>
<p>The Member Code must be formed as follows:</p>
<p><strong>"NTRCONTRYCODE-ORGANIZATIONREGISTRYCODE"</strong> - without whitespaces</p>
<p>Where:</p>
<ul>
<li>"NTR" - Prefix of the legal entity identifier according to ETSI EN 319 412-1 clause 5.1.4.</li>
<li>COUNTRY CODE - Country code according to ISO 3166 (Alpha 2)</li>
<li>
<code>-</code> hyphen</li>
<li>ORGANIZATION REGISTRY CODE - Organizational registry code in the organization's country.</li>
</ul>
<p>Example:</p>
<ul>
<li>Lexbyte Digital Limited, a registered organization in Malta</li>
<li>Member Name: <strong>Lexbyte Digital Limited</strong>
</li>
<li>Member Class: <strong>NEE</strong>
</li>
<li>Member Code: <strong>NTRMT-C56249</strong>
</li>
</ul>
<p>Such requirements to the NEE Member Code are necessary to ensure the uniqueness of the Member Code of foreign organizations on X-Road (X-tee). In addition, the Member Code of X-Road members must correspond to the Organization Identifier (2.5.4.97) field in the SK ID Solutions AS e-Seal certificate profile.</p>
<p>References:</p>
<ul>
<li>SK ID Solutions AS certificate profile: <a href="https://sk.ee/upload/files/SK-CPR-KLASS3-EN-v8_0-20171130.pdf" rel="nofollow">https://sk.ee/upload/files/SK-CPR-KLASS3-EN-v8_0-20171130.pdf</a>
</li>
<li>ETSI EN 319 412-1: <a href="http://www.etsi.org/deliver/etsi_en/319400_319499/31941201/01.01.00_30/en_31941201v010100v.pdf" rel="nofollow">http://www.etsi.org/deliver/etsi_en/319400_319499/31941201/01.01.00_30/en_31941201v010100v.pdf</a>
</li>
<li>Alpha 2 country code: <a href="https://www.iso.org/obp/ui/#search" rel="nofollow">https://www.iso.org/obp/ui/#search</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Security server code (<strong>reference data: 2.4</strong>), which is chosen by the security server administrator and which has to be unique across all the security servers belonging to the same X-Road member.</p>
</li>
<li>
<p>Software token’s PIN (<strong>reference data: 2.5</strong>). The PIN will be used to protect the keys stored in the software token. The PIN must be stored in a secure place, because it will be no longer possible to use or recover the private keys in the token once the PIN has been lost.</p>
</li>
</ul>
<h2>
<a id="4-installation-error-handling" class="anchor" href="#4-installation-error-handling" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>4 Installation Error handling</h2>
<h3>
<a id="41-cannot-set-lc_all-to-default-locale" class="anchor" href="#41-cannot-set-lc_all-to-default-locale" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>4.1 Cannot Set LC_ALL to Default Locale</h3>
<p>If running the locale command results in the error message</p>
<pre><code>locale: Cannot set LC_ALL to default locale: No such file or directory,
</code></pre>
<p>then the support for this particular language has not been installed. To install it, run the command (the example uses the English language):</p>
<pre><code>sudo apt-get install language-pack-en
</code></pre>
<p>Then, to update the system’s locale files, run the following commands (the example uses the US locale):</p>
<pre><code>sudo locale-gen en_US.UTF-8
sudo update-locale en_US.UTF-8
</code></pre>
<p>Set operating system locale. Add following line to <code>/etc/environment</code> file:</p>
<pre><code>LC_ALL=en_US.UTF-8
</code></pre>
<p>After updating the system’s locale settings, it is recommended to restart the operating system.</p>
<h3>
<a id="42-postgresql-is-not-utf8-compatible" class="anchor" href="#42-postgresql-is-not-utf8-compatible" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>4.2 PostgreSQL Is Not UTF8 Compatible</h3>
<p>If the security server installation is aborted with the error message</p>
<pre><code>postgreSQL is not UTF8 compatible,
</code></pre>
<p>then the PostgreSQL package is installed with a wrong locale. One way to resolve it is to remove the data store created upon the PostgreSQL installation and recreate it with the correct encoding.</p>
<p><strong>WARNING</strong>: All data in the database will be erased!</p>
<pre><code>sudo pg_dropcluster --stop 9.3 main
LC_ALL="en_US.UTF-8" sudo pg_createcluster --start 9.3 main
</code></pre>
<p>To complete the interrupted installation, run the command</p>
<pre><code>sudo apt-get -f install
</code></pre>
<h3>
<a id="43-could-not-create-default-cluster" class="anchor" href="#43-could-not-create-default-cluster" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>4.3 Could Not Create Default Cluster</h3>
<p>If the following error message is displayed during PostgreSQL installation:</p>
<pre><code>Error: The locale requested by the environment is invalid.
Error: could not create default cluster. Please create it manually with pg_createcluster 9.3 main –start,
</code></pre>
<p>use the following command to create the PostgreSQL data cluster:</p>
<pre><code>LC_ALL="en_US.UTF-8" sudo pg_createcluster --start 9.3 main
</code></pre>
<p>The interrupted installation can be finished using</p>
<pre><code>sudo apt-get -f install
</code></pre>
<h3>
<a id="44-is-postgres-running-on-port-5432" class="anchor" href="#44-is-postgres-running-on-port-5432" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>4.4 Is Postgres Running On Port 5432?</h3>
<p>If the following error message appears during installation</p>
<pre><code>Is postgres running on port 5432 ?
Aborting installation! please fix issues and rerun with apt-get -f install,
</code></pre>
<p>check if any of the following errors occurred during the installation of PostgreSQL.</p>
<ul>
<li>
<p>Error installing the data cluster. Refer to section <a href="#43-could-not-create-default-cluster">“Could not create default cluster”</a>.</p>
</li>
<li>
<p>The PostgreSQL data cluster installed during the installation of the security server is not configured to listen on port 5432. To verify and configure the listening port, edit the PostgreSQL configuration file in <code>/etc/postgresql/9.3/main/postgresql.conf</code>. If you change the listening port, the postgresql service must be restarted.</p>
</li>
</ul>
<p>The interrupted installation can be finished using</p>
<pre><code>sudo apt-get -f install
</code></pre>
<h3>
<a id="45-different-versions-of-xroad--packages-after-successful-upgrade" class="anchor" href="#45-different-versions-of-xroad--packages-after-successful-upgrade" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>4.5 Different versions of xroad-* packages after successful upgrade</h3>
<p>Sometimes, after using <code>sudo apt-get upgrade</code> command, some of the packages are not upgraded. In the following example <code>xroad-securityserver</code> package version is still 6.8.3 although other packages are upgraded to 6.8.5:</p>
<pre><code># sudo dpkg -l | grep xroad-
ii xroad-addon-messagelog 6.8.5.20160929134539gitfe60f90
ii xroad-addon-metaservices 6.8.5.20160929134539gitfe60f90
ii xroad-addon-wsdlvalidator 6.8.5.20160929134539gitfe60f90
ii xroad-common 6.8.5.20160929134539gitfe60f90
ii xroad-jetty9 6.8.5.20160929134539gitfe60f90
ii xroad-proxy 6.8.5.20160929134539gitfe60f90
ii xroad-securityserver 6.8.3-3-201605131138
</code></pre>
<p><code>apt-get upgrade</code> command doesn’t install new packages - in this particular case new packages <code>xroad-monitor</code> and <code>xroad-addon-proxymonitor</code> installation is needed for upgrade of <code>xroad-securityserver</code> package.</p>
<p>To be sure that packages are installed correctly please use <code>sudo apt upgrade</code> or <code>sudo apt full-upgrade</code> commands.</p>
    </article>
  </body>
</html>
