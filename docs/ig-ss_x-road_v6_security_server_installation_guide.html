<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="github-markdown.css">
    <style>
      .markdown-body {
        box-sizing: border-box;
        min-width: 200px;
        max-width: 980px;
        margin: 0 auto;
        padding: 45px;
      }
    </style>
    <title>X-Road: 7.6.0
</title>
  </head>
  <body>
    <article class="markdown-body">
<div class="markdown-heading"><h1 class="heading-element">Security Server Installation Guide for Ubuntu 
</h1><a id="security-server-installation-guide-for-ubuntu-" class="anchor" aria-label="Permalink: Security Server Installation Guide for Ubuntu " href="#security-server-installation-guide-for-ubuntu-"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p><strong>X-ROAD 7</strong></p>
<p>Version: 2.47<br>
Doc. ID: IG-SS</p>
<hr>
<div class="markdown-heading"><h2 class="heading-element">Version history 
</h2><a id="version-history-" class="anchor" aria-label="Permalink: Version history " href="#version-history-"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<table>
<thead>
<tr>
<th>Date</th>
<th>Version</th>
<th>Description</th>
<th>Author</th>
</tr>
</thead>
<tbody>
<tr>
<td>01.12.2014</td>
<td>1.0</td>
<td>Initial version</td>
<td></td>
</tr>
<tr>
<td>19.01.2015</td>
<td>1.1</td>
<td>License information added</td>
<td></td>
</tr>
<tr>
<td>18.03.2015</td>
<td>1.2</td>
<td>Meta-package for Security Server added. Legacy securelog module removed</td>
<td></td>
</tr>
<tr>
<td>02.04.2015</td>
<td>1.3</td>
<td>“sdsb” change to “xroad”</td>
<td></td>
</tr>
<tr>
<td>27.05.2015</td>
<td>1.4</td>
<td>Some typos fixed</td>
<td></td>
</tr>
<tr>
<td>30.06.2015</td>
<td>1.5</td>
<td>Minor corrections done</td>
<td></td>
</tr>
<tr>
<td>06.07.2015</td>
<td>1.6</td>
<td>New repository address</td>
<td></td>
</tr>
<tr>
<td>18.09.2015</td>
<td>1.7</td>
<td>Reference data in <a href="#32-reference-data">3.2</a> updated</td>
<td></td>
</tr>
<tr>
<td>18.09.2015</td>
<td>2.0</td>
<td>Editorial changes made</td>
<td></td>
</tr>
<tr>
<td>13.10.2015</td>
<td>2.1</td>
<td>Editorial changes made</td>
<td></td>
</tr>
<tr>
<td>10.12.2015</td>
<td>2.2</td>
<td>Updated the installing of the support for hardware tokens (<a href="#27-installing-the-support-for-hardware-tokens">2.7</a>)</td>
<td></td>
</tr>
<tr>
<td>17.12.2015</td>
<td>2.3</td>
<td>Added <em>xroad-addon-wsdlvalidator</em> package</td>
<td></td>
</tr>
<tr>
<td>19.05.2016</td>
<td>2.4</td>
<td>Merged changes from xtee6-doc repo. Updated table <a href="#22-reference-data">2.2</a> with p 1.12, added chapter <a href="#28-installing-support-for-monitoring">2.8</a> and updated <a href="#32-reference-data">3.2</a>.</td>
<td></td>
</tr>
<tr>
<td>30.09.2016</td>
<td>2.5</td>
<td>Added chapter „<a href="#45-different-versions-of-xroad--packages-after-successful-upgrade">Different versions of xroad-* package after successful upgrade</a>“.</td>
<td></td>
</tr>
<tr>
<td>07.12.2016</td>
<td>2.6</td>
<td>Added operational data monitoring packages. 2 GB RAM -&gt; 3 GB RAM</td>
<td></td>
</tr>
<tr>
<td>23.02.2017</td>
<td>2.7</td>
<td>Converted to Github flavoured Markdown, added license text, adjusted tables for better output in PDF</td>
<td>Toomas Mölder</td>
</tr>
<tr>
<td>13.04.2017</td>
<td>2.8</td>
<td>Added token ID formatting</td>
<td>Cybernetica AS</td>
</tr>
<tr>
<td>22.01.2018</td>
<td>2.8.1</td>
<td>Added NEE and NGO member classes</td>
<td>Jürgen Šuvalov</td>
</tr>
<tr>
<td>25.08.2017</td>
<td>2.9</td>
<td>Update environmental monitoring installation information</td>
<td>Ilkka Seppälä</td>
</tr>
<tr>
<td>15.09.2017</td>
<td>2.10</td>
<td>Added package with configuration specific to Estonia xroad-securityserver-ee</td>
<td>Cybernetica AS</td>
</tr>
<tr>
<td>05.03.2018</td>
<td>2.11</td>
<td>Added terms and abbreviations reference and document links</td>
<td>Tatu Repo</td>
</tr>
<tr>
<td>10.04.2018</td>
<td>2.12</td>
<td>Updated chapter "<a href="#27-installing-the-support-for-hardware-tokens">Installing the Support for Hardware Tokens</a>" with configurable parameters described in the configuration file 'devices.ini'</td>
<td>Cybernetica AS</td>
</tr>
<tr>
<td>07.06.2018</td>
<td>2.12.1</td>
<td>Updated repository information with x-tee.ee domain</td>
<td>Jürgen Šuvalov</td>
</tr>
<tr>
<td>03.07.2018</td>
<td>2.12.2</td>
<td>Added network diagram and reference data for monitoring servers</td>
<td>Jürgen Šuvalov</td>
</tr>
<tr>
<td>08.08.2018</td>
<td>2.12.3</td>
<td>Editorial changes</td>
<td>Jan Raik</td>
</tr>
<tr>
<td>13.08.2018</td>
<td>2.12.4</td>
<td>Package name fix</td>
<td>Taavi Meinberg</td>
</tr>
<tr>
<td>14.10.2018</td>
<td>2.13</td>
<td>Update package repository address</td>
<td>Petteri Kivimäki</td>
</tr>
<tr>
<td>25.10.2018</td>
<td>2.14</td>
<td>Add RHEL7 as supported platform, update section 2.2 Reference data</td>
<td>Petteri Kivimäki</td>
</tr>
<tr>
<td>15.11.2018</td>
<td>2.15</td>
<td>Add Ubuntu 18 installation instructions</td>
<td>Jarkko Hyöty</td>
</tr>
<tr>
<td>28.01.2018</td>
<td>2.16</td>
<td>Update port 2080 documentation</td>
<td>Petteri Kivimäki</td>
</tr>
<tr>
<td>30.05.2019</td>
<td>2.17</td>
<td>Added package installation instructions on chapter "<a href="#24-preparing-os">2.4 Preparing OS</a>"</td>
<td>Raul Martinez</td>
</tr>
<tr>
<td>11.09.2019</td>
<td>2.18</td>
<td>Remove Ubuntu 14.04 from supported platforms</td>
<td>Jarkko Hyöty</td>
</tr>
<tr>
<td>20.09.2019</td>
<td>2.19</td>
<td>Add instructions for using remote databases</td>
<td>Ilkka Seppälä</td>
</tr>
<tr>
<td>12.04.2020</td>
<td>2.20</td>
<td>Add note about the default value of the <em>connector-host</em> property in the EE-package</td>
<td>Petteri Kivimäki</td>
</tr>
<tr>
<td>29.04.2020</td>
<td>2.21</td>
<td>Add instructions how to use remote database located in Microsoft Azure</td>
<td>Ilkka Seppälä</td>
</tr>
<tr>
<td>12.06.2020</td>
<td>2.22</td>
<td>Update reference data regarding JMX listening ports</td>
<td>Petteri Kivimäki</td>
</tr>
<tr>
<td>24.06.2020</td>
<td>2.23</td>
<td>Add repository sign key details in section <a href="#22-reference-data">2.2 Reference data</a>
</td>
<td>Petteri Kivimäki</td>
</tr>
<tr>
<td>24.06.2020</td>
<td>2.24</td>
<td>Remove environmental and operational monitoring daemon JMX listening ports from section <a href="#22-reference-data">2.2 Reference data</a>
</td>
<td>Petteri Kivimäki</td>
</tr>
<tr>
<td>09.08.2020</td>
<td>2.25</td>
<td>Update ports information in section <a href="#22-reference-data">2.2 Reference data</a>, add section <a href="#221-network-diagram">2.2.1 Network Diagram</a>
</td>
<td>Petteri Kivimäki</td>
</tr>
<tr>
<td>17.08.2020</td>
<td>2.26</td>
<td>Update for RHEL 8.</td>
<td>Jarkko Hyöty</td>
</tr>
<tr>
<td>08.09.2020</td>
<td>2.27</td>
<td>Fix minimum RAM requirement.</td>
<td>Ilkka Seppälä</td>
</tr>
<tr>
<td>16.09.2020</td>
<td>2.28</td>
<td>Describe deployment options and database customization options.</td>
<td>Ilkka Seppälä</td>
</tr>
<tr>
<td>29.09.2020</td>
<td>2.29</td>
<td>Add instructions for creating database structure and roles manually.</td>
<td>Ilkka Seppälä</td>
</tr>
<tr>
<td>19.01.2021</td>
<td>2.30</td>
<td>Add instructions for using an alternative Java distribution.</td>
<td>Jarkko Hyöty</td>
</tr>
<tr>
<td>04.02.2021</td>
<td>2.31</td>
<td>Minor updates.</td>
<td>Ilkka Seppälä</td>
</tr>
<tr>
<td>13.04.2021</td>
<td>2.32</td>
<td>Update minimum requirements in section <a href="#22-reference-data">2.2 Reference data</a>
</td>
<td>Petteri Kivimäki</td>
</tr>
<tr>
<td>16.04.2021</td>
<td>2.33</td>
<td>Update remote database installation instructions</td>
<td>Jarkko Hyöty</td>
</tr>
<tr>
<td>18.05.2021</td>
<td>2.34</td>
<td>Update error handling section</td>
<td>Ilkka Seppälä</td>
</tr>
<tr>
<td>02.06.2021</td>
<td>2.35</td>
<td>Add backup encryption information</td>
<td>Andres Allkivi</td>
</tr>
<tr>
<td>01.07.2021</td>
<td>2.36</td>
<td>Update 3rd party key server</td>
<td>Petteri Kivimäki</td>
</tr>
<tr>
<td>11.08.2021</td>
<td>2.37</td>
<td>Minor updates</td>
<td>Petteri Kivimäki</td>
</tr>
<tr>
<td>18.08.2021</td>
<td>2.38</td>
<td>Minor updates to Annex D</td>
<td>Ilkka Seppälä</td>
</tr>
<tr>
<td>25.08.2021</td>
<td>2.39</td>
<td>Update X-Road references from version 6 to 7</td>
<td>Caro Hautamäki</td>
</tr>
<tr>
<td>26.08.2021</td>
<td>2.40</td>
<td>Add instructions how to disable the messagelog addon before installing, add section <a href="#27-disable-the-messagelog-addon-before-installation-optional">2.7 Disable the Messagelog Addon before Installation (optional)</a>
</td>
<td>Caro Hautamäki</td>
</tr>
<tr>
<td>03.08.2021</td>
<td>2.41</td>
<td>Minor fixes</td>
<td>Ilkka Seppälä</td>
</tr>
<tr>
<td>06.09.2021</td>
<td>2.42</td>
<td>Update list of running services</td>
<td>Jarkko Hyöty</td>
</tr>
<tr>
<td>26.09.2022</td>
<td>2.43</td>
<td>Remove Ubuntu 18.04 support</td>
<td>Andres Rosenthal</td>
</tr>
<tr>
<td>23.05.2023</td>
<td>2.44</td>
<td>Minor backup encryption configuration fixes</td>
<td>Eneli Reimets</td>
</tr>
<tr>
<td>01.06.2023</td>
<td>2.45</td>
<td>Update references</td>
<td>Petteri Kivimäki</td>
</tr>
<tr>
<td>20.11.2023</td>
<td>2.46</td>
<td>Update firewall configuration documentation</td>
<td>Taavi Meinberg</td>
</tr>
<tr>
<td>27.11.2023</td>
<td>2.47</td>
<td>Updated default proxy client http(s) ports</td>
<td>Mikk-Erik Bachmann</td>
</tr>
</tbody>
</table>
<div class="markdown-heading"><h2 class="heading-element">License</h2><a id="license" class="anchor" aria-label="Permalink: License" href="#license"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>This document is licensed under the Creative Commons Attribution-ShareAlike 3.0 Unported License. To view a copy of this license, visit <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="nofollow">http://creativecommons.org/licenses/by-sa/3.0/</a></p>
<div class="markdown-heading"><h2 class="heading-element">Table of Contents 
</h2><a id="table-of-contents-" class="anchor" aria-label="Permalink: Table of Contents " href="#table-of-contents-"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>


<ul>
<li><a href="#license">License</a></li>
<li>
<a href="#1-introduction">1 Introduction</a>
<ul>
<li><a href="#11-target-audience">1.1 Target Audience</a></li>
<li><a href="#12-terms-and-abbreviations">1.2 Terms and abbreviations</a></li>
<li><a href="#13-references">1.3 References</a></li>
</ul>
</li>
<li>
<a href="#2-installation">2 Installation</a>
<ul>
<li><a href="#21-prerequisites-to-installation">2.1 Prerequisites to Installation</a></li>
<li>
<a href="#22-reference-data">2.2 Reference Data</a>
<ul>
<li><a href="#221-network-diagram">2.2.1 Network Diagram</a></li>
<li><a href="#231-ria-ips-for-whitelisting">2.3.1 RIA IP's for Whitelisting</a></li>
</ul>
</li>
<li><a href="#23-requirements-for-the-security-server">2.3 Requirements for the Security Server</a></li>
<li><a href="#24-preparing-os">2.4 Preparing OS</a></li>
<li><a href="#25-setup-package-repository">2.5 Setup Package Repository</a></li>
<li><a href="#26-remote-database-setup-optional">2.6 Remote Database Setup (optional)</a></li>
<li><a href="#27-disable-the-messagelog-addon-before-installation-optional">2.7 Disable the Messagelog Addon before Installation (optional)</a></li>
<li><a href="#28-security-server-installation">2.8 Security Server Installation</a></li>
<li><a href="#29-post-installation-checks">2.9 Post-Installation Checks</a></li>
<li><a href="#210-installing-the-support-for-hardware-tokens">2.10 Installing the Support for Hardware Tokens</a></li>
<li><a href="#211-installing-the-support-for-environmental-monitoring">2.11 Installing the Support for Environmental Monitoring</a></li>
</ul>
</li>
<li>
<a href="#3-security-server-initial-configuration">3 Security Server Initial Configuration</a>
<ul>
<li><a href="#31-prerequisites">3.1 Prerequisites</a></li>
<li><a href="#32-reference-data">3.2 Reference Data</a></li>
<li><a href="#33-configuration">3.3 Configuration</a></li>
<li>
<a href="#34-configuring-firewall">3.4 Configuring firewall</a>
<ul>
<li><a href="#341-accepting-connections">3.4.1 Accepting Connections</a></li>
</ul>
</li>
<li><a href="#35-configuring-configuration-backup-encryption">3.5 Configuring configuration backup encryption</a></li>
</ul>
</li>
<li>
<a href="#4-installation-error-handling">4 Installation Error handling</a>
<ul>
<li><a href="#41-cannot-set-lc_all-to-default-locale">4.1 Cannot Set LC_ALL to Default Locale</a></li>
<li><a href="#42-postgresql-is-not-utf8-compatible">4.2 PostgreSQL Is Not UTF8 Compatible</a></li>
<li><a href="#43-could-not-create-default-cluster">4.3 Could Not Create Default Cluster</a></li>
<li><a href="#44-is-postgres-running-on-port-5432">4.4 Is Postgres Running On Port 5432?</a></li>
<li><a href="#45-different-versions-of-xroad--packages-after-successful-upgrade">4.5 Different versions of xroad-* packages after successful upgrade</a></li>
<li><a href="#46-error-upgrade-supported-from-version-xyz-or-newer">4.6 ERROR: Upgrade supported from version X.Y.Z or newer</a></li>
</ul>
</li>
<li><a href="#annex-a-security-server-default-database-properties">Annex A Security Server Default Database Properties</a></li>
<li><a href="#annex-b-default-database-users">Annex B Default Database Users</a></li>
<li>
<a href="#annex-c-deployment-options">Annex C Deployment Options</a>
<ul>
<li><a href="#c1-general">C.1 General</a></li>
<li><a href="#c2-local-database">C.2 Local Database</a></li>
<li><a href="#c3-remote-database">C.3 Remote Database</a></li>
<li><a href="#c4-high-availability-setup">C.4 High Availability Setup</a></li>
<li><a href="#c5-load-balancing-setup">C.5 Load Balancing Setup</a></li>
<li><a href="#c6-summary">C.6 Summary</a></li>
</ul>
</li>
<li><a href="#annex-d-create-database-structure-manually">Annex D Create Database Structure Manually</a></li>
</ul>


<div class="markdown-heading"><h2 class="heading-element">1 Introduction</h2><a id="1-introduction" class="anchor" aria-label="Permalink: 1 Introduction" href="#1-introduction"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="markdown-heading"><h3 class="heading-element">1.1 Target Audience</h3><a id="11-target-audience" class="anchor" aria-label="Permalink: 1.1 Target Audience" href="#11-target-audience"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>The intended audience of this Installation Guide are X-Road Security server system administrators responsible for installing and using X-Road software. The daily operation and maintenance of the Security Server is covered by its User Guide [<a href="#Ref_UG-SS">UG-SS</a>].</p>
<p>The document is intended for readers with a moderate knowledge of Linux server management, computer networks, and the X-Road working principles.</p>
<div class="markdown-heading"><h3 class="heading-element">1.2 Terms and abbreviations</h3><a id="12-terms-and-abbreviations" class="anchor" aria-label="Permalink: 1.2 Terms and abbreviations" href="#12-terms-and-abbreviations"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>See X-Road terms and abbreviations documentation [<a href="#Ref_TERMS">TA-TERMS</a>].</p>
<div class="markdown-heading"><h3 class="heading-element">1.3 References</h3><a id="13-references" class="anchor" aria-label="Permalink: 1.3 References" href="#13-references"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ol>
<li>
<p><a id="Ref_UG-SS"></a>[UG-SS] X-Road 7. Security Server User Guide. Document ID: <a href="ug-ss_x-road_6_security_server_user_guide.html">UG-SS</a></p>
</li>
<li>
<p><a id="Ref_TERMS"></a>[TA-TERMS] X-Road Terms and Abbreviations. Document ID: <a href="terms_x-road_docs.html">TA-TERMS</a>.</p>
</li>
<li>
<p><a name="Ref_UG-SYSPAR"></a>[UG-SYSPAR] X-Road: System Parameters User Guide. Document ID:
<a href="ug-syspar_x-road_v6_system_parameters.html">UG-SYSPAR</a>.</p>
</li>
<li>
<p><a name="Ref_IG-XLB"></a>[IG-XLB] X-Road: External Load Balancer Installation Guide. Document ID:
<a href="ig-xlb_x-road_external_load_balancer_installation_guide.html">IG-XLB</a>.</p>
</li>
</ol>
<div class="markdown-heading"><h2 class="heading-element">2 Installation</h2><a id="2-installation" class="anchor" aria-label="Permalink: 2 Installation" href="#2-installation"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="markdown-heading"><h3 class="heading-element">2.1 Prerequisites to Installation</h3><a id="21-prerequisites-to-installation" class="anchor" aria-label="Permalink: 2.1 Prerequisites to Installation" href="#21-prerequisites-to-installation"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>There are multiple alternatives how the Security Server can be deployed. The options are described in <a href="#annex-c-deployment-options">Annex C Deployment Options</a>.</p>
<p>The Security Server is officially supported on the following platforms:</p>
<ul>
<li>Ubuntu Server 20.04 or 22.04 Long-Term Support (LTS) operating system on a x86-64 platform.</li>
<li>Red Hat Enterprise Linux (RHEL) 7 and 8 (x86-64).</li>
</ul>
<p>NB: RIA provides support only for Security Servers which are installed on the Ubuntu operating system.</p>
<p>The software can be installed both on physical and virtualized hardware (of the latter, Xen and Oracle VirtualBox have been tested).</p>
<div class="markdown-heading"><h3 class="heading-element">2.2 Reference Data</h3><a id="22-reference-data" class="anchor" aria-label="Permalink: 2.2 Reference Data" href="#22-reference-data"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p><em>Note</em>: The information in empty cells should be determined before the server’s installation, by the person performing the installation.</p>
<p><strong>Caution</strong>: Data necessary for the functioning of the operating system is not included.</p>
<table>
<thead>
<tr>
<th><strong>Ref</strong></th>
<th></th>
<th><strong>Explanation</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>1.0</td>
<td>Ubuntu 18.04, Ubuntu 20.04 (x86-64)<br>3 GB RAM, 3 GB free disk space</td>
<td>Minimum requirements without the <code>monitoring</code> and <code>op-monitoring</code> add-ons. With the add-ons minimum of 4 GB of RAM is required.</td>
</tr>
<tr>
<td>1.1</td>
<td><a href="http://x-tee.ee/packages/live/xroad" rel="nofollow">http://x-tee.ee/packages/live/xroad</a></td>
<td>X-Road stable package repository</td>
</tr>
<tr>
<td> </td>
<td><a href="http://x-tee.ee/packages/test/xroad" rel="nofollow">http://x-tee.ee/packages/test/xroad</a></td>
<td>X-Road test package repository</td>
</tr>
<tr>
<td>1.2</td>
<td><a href="https://x-tee.ee/packages/live/xroad/xroad.pub" rel="nofollow">https://x-tee.ee/packages/live/xroad/xroad.pub</a></td>
<td>The repository key</td>
</tr>
<tr>
<td>1.3</td>
<td></td>
<td>Account name in the user interface</td>
</tr>
<tr>
<td>1.4</td>
<td><strong>Inbound ports from external network</strong></td>
<td>Ports for inbound connections from the external network to the security server</td>
</tr>
<tr>
<td> </td>
<td>TCP 5500</td>
<td>Message exchange between security servers. Recommended to use IP filtering (<strong>whitelisting only <a href="#231-ria-ips-for-whitelisting">RIA IP's</a> and partners</strong>).</td>
</tr>
<tr>
<td> </td>
<td>TCP 5577</td>
<td>Querying of OCSP responses between security servers. Recommended to use IP filtering (<strong>whitelisting only <a href="#231-ria-ips-for-whitelisting">RIA IP's</a> and partners</strong>)</td>
</tr>
<tr>
<td>1.5</td>
<td><strong>Outbound ports to external network</strong></td>
<td>Ports for outbound connections from the security server to the external network</td>
</tr>
<tr>
<td> </td>
<td>TCP 5500</td>
<td>Message exchange between security servers</td>
</tr>
<tr>
<td> </td>
<td>TCP 5577</td>
<td>Querying of OCSP responses between security servers</td>
</tr>
<tr>
<td> </td>
<td>TCP 4001</td>
<td>Communication with the central server</td>
</tr>
<tr>
<td> </td>
<td>TCP 80</td>
<td>Downloading global configuration from the central server</td>
</tr>
<tr>
<td> </td>
<td>TCP 80,443</td>
<td>Most common OCSP and time-stamping services</td>
</tr>
<tr>
<td>1.6</td>
<td><strong>Inbound ports from internal network</strong></td>
<td>Ports for inbound connections from the internal network to the security server</td>
</tr>
<tr>
<td> </td>
<td>TCP 4000</td>
<td>User interface and management REST API (local network). <strong>Must not be accessible from the internet!</strong>
</td>
</tr>
<tr>
<td> </td>
<td>TCP 80, 443</td>
<td>Information system access points (in the local network). <strong>Must not be accessible from the external network without strong authentication. If open to the external network, IP filtering is strongly recommended.</strong>
</td>
</tr>
<tr>
<td> </td>
<td>TCP 9011</td>
<td>Operational data monitoring daemon JMX listening port</td>
</tr>
<tr>
<td> </td>
<td>TCP 9999</td>
<td>Environmental monitoring daemon JMX listening port</td>
</tr>
<tr>
<td>1.7</td>
<td><strong>Outbound ports to internal network</strong></td>
<td>Ports for inbound connections from the internal network to the security server</td>
</tr>
<tr>
<td> </td>
<td>TCP 80, 443, <em>other</em>
</td>
<td>Producer information system endpoints</td>
</tr>
<tr>
<td> </td>
<td>TCP 2080</td>
<td>Message exchange between security server and operational data monitoring daemon (by default on localhost)</td>
</tr>
<tr>
<td>1.8</td>
<td></td>
<td>Security server internal IP address(es) and hostname(s)</td>
</tr>
<tr>
<td>1.9</td>
<td></td>
<td>Security server public IP address, NAT address</td>
</tr>
<tr>
<td>1.10</td>
<td>&lt;by default, the server’s IP addresses and names are added to the certificate’s Distinguished Name (DN) field&gt;</td>
<td>Information about the user interface TLS certificate</td>
</tr>
<tr>
<td>1.11</td>
<td>&lt;by default, the server’s IP addresses and names are added to the certificate’s Distinguished Name (DN) field&gt;</td>
<td>Information about the services TLS certificate</td>
</tr>
</tbody>
</table>
<p>It is strongly recommended to protect the security server from unwanted access using a firewall (hardware or software based). The firewall can be applied to both incoming and outgoing connections depending on the security requirements of the environment where the security server is deployed. It is recommended to allow incoming traffic to specific ports only from explicitly defined sources using IP filtering. <strong>Special attention should be paid with the firewall configuration since incorrect configuration may leave the security server vulnerable to exploits and attacks.</strong></p>
<p>The table below lists the required connections between different components.</p>
<table>
<thead>
<tr>
<th><strong>Connection Type</strong></th>
<th><strong>Source</strong></th>
<th><strong>Target</strong></th>
<th><strong>Target Ports</strong></th>
<th><strong>Protocol</strong></th>
<th><strong>Note</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Out</td>
<td>Security Server</td>
<td>Central Server</td>
<td>80, 4001</td>
<td>tcp</td>
<td></td>
</tr>
<tr>
<td>Out</td>
<td>Security Server</td>
<td>Management Security Server</td>
<td>5500, 5577</td>
<td>tcp</td>
<td></td>
</tr>
<tr>
<td>Out</td>
<td>Security Server</td>
<td>OCSP Service</td>
<td>80 / 443</td>
<td>tcp</td>
<td></td>
</tr>
<tr>
<td>Out</td>
<td>Security Server</td>
<td>Timestamping Service</td>
<td>80 / 443</td>
<td>tcp</td>
<td></td>
</tr>
<tr>
<td>Out</td>
<td>Security Server</td>
<td>Data Exchange Partner Security Server (Service Producer)</td>
<td>5500, 5577</td>
<td>tcp</td>
<td></td>
</tr>
<tr>
<td>Out</td>
<td>Security Server</td>
<td>Producer Information System</td>
<td>80, 443, other</td>
<td>tcp</td>
<td>Target in the internal network</td>
</tr>
<tr>
<td>In</td>
<td>Monitoring Security Server</td>
<td>Security Server</td>
<td>5500, 5577</td>
<td>tcp</td>
<td></td>
</tr>
<tr>
<td>In</td>
<td>Data Exchange Partner Security Server (Service Consumer)</td>
<td>Security Server</td>
<td>5500, 5577</td>
<td>tcp</td>
<td></td>
</tr>
<tr>
<td>In</td>
<td>Consumer Information System</td>
<td>Security Server</td>
<td>80, 443</td>
<td>tcp</td>
<td>Source in the internal network</td>
</tr>
<tr>
<td>In</td>
<td>Admin</td>
<td>Security Server</td>
<td>4000</td>
<td>tcp</td>
<td>Source in the internal network</td>
</tr>
</tbody>
</table>
<p>It is strongly recommended to protect the security server from unwanted access using a firewall (hardware or software based). The firewall can be applied to both incoming and outgoing connections depending on the security requirements of the environment where the security server is deployed. It is recommended to allow incoming traffic to specific ports only from explicitly defined sources using IP filtering. <strong>Special attention should be paid with the firewall configuration since incorrect configuration may leave the security server vulnerable to exploits and attacks.</strong></p>
<div class="markdown-heading"><h4 class="heading-element">2.2.1 Network Diagram</h4><a id="221-network-diagram" class="anchor" aria-label="Permalink: 2.2.1 Network Diagram" href="#221-network-diagram"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>The following network diagram is an example of a simple stand-alone Security Server setup. Attention should be paid when configuring the firewall of your Security Server, as misconfigurations (e.g. exposing port 80/tcp to the public internet) can leave your server vulnerable. <strong>IP whitelisting should be used for all ports that are open to the external network.</strong></p>
<p>Allowing incoming connections from the Monitoring Security Server on ports 5500/tcp and 5577/tcp (<a href="#231-ria-ips-for-whitelisting">monitoring server IP's</a>) is necessary for the X-Road Center to be able to monitor the ecosystem and provide statistics and support for Members.</p>
<p><strong>Caution</strong>: The enabling of auxiliary services which are necessary for the functioning and management of the operating system (such as DNS, NTP, and SSH) stay outside the scope of this guide.</p>
<p><a target="_blank" rel="noopener noreferrer" href="img/ig-ss_network_diagram.png"><img src="img/ig-ss_network_diagram.png" alt="network diagram" style="max-width: 100%;"></a></p>
<div class="markdown-heading"><h4 class="heading-element">2.3.1 RIA IP's for Whitelisting</h4><a id="231-ria-ips-for-whitelisting" class="anchor" aria-label="Permalink: 2.3.1 RIA IP's for Whitelisting" href="#231-ria-ips-for-whitelisting"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<table>
<thead>
<tr>
<th>Type</th>
<th><strong>EE - production</strong></th>
<th><strong>ee-test</strong></th>
<th><strong>ee-dev</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Central Server</td>
<td>cs1.ee.x-tee.ee <br> cs2.ee.x-tee.ee <br> cs3.ee.x-tee.ee</td>
<td>cs1.test.x-tee.ee <br> cs2.test.x-tee.ee <br> cs3.test.x-tee.ee</td>
<td>cs1.dev.x-tee.ee <br> cs2.dev.x-tee.ee <br> cs3.dev.x-tee.ee</td>
</tr>
<tr>
<td>Central Monitoring Server</td>
<td>mon.ee.x-tee.ee</td>
<td>mon.test.x-tee.ee</td>
<td>mon.dev.x-tee.ee</td>
</tr>
<tr>
<td>Management Security Server</td>
<td>ht1.ee.x-tee.ee <br> ht2.ee.x-tee.ee <br> ht3.ee.x-tee.ee</td>
<td>ht1.test.x-tee.ee <br> ht2.test.x-tee.ee <br> ht3.test.x-tee.ee</td>
<td>ht1.dev.x-tee.ee <br> ht2.dev.x-tee.ee <br> ht3.dev.x-tee.ee</td>
</tr>
</tbody>
</table>
<div class="markdown-heading"><h3 class="heading-element">2.3 Requirements for the Security Server</h3><a id="23-requirements-for-the-security-server" class="anchor" aria-label="Permalink: 2.3 Requirements for the Security Server" href="#23-requirements-for-the-security-server"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>Minimum recommended hardware parameters:</p>
<ul>
<li>the server’s hardware (motherboard, CPU, network interface cards, storage system) must be supported by Ubuntu in general;</li>
<li>a 64-bit dual-core Intel, AMD or compatible CPU; AES instruction set support is highly recommended;</li>
<li>4 GB RAM;</li>
<li>a 100 Mbps network interface card;</li>
<li>if necessary, interfaces for the use of hardware tokens.</li>
</ul>
<p>Requirements to software and settings:</p>
<ul>
<li>an installed and configured Ubuntu 20.04 LTS or 22.04 LTS x86-64 operating system;</li>
<li>if the Security Server is separated from other networks by a firewall and/or NAT, the necessary connections to and from the Security Server are allowed (<strong>reference data: 1.4; 1.5; 1.6; 1.7</strong>). The enabling of auxiliary services which are necessary for the functioning and management of the operating system (such as DNS, NTP, and SSH) stay outside the scope of this guide;</li>
<li>if the Security Server has a private IP address, a corresponding NAT record must be created in the firewall (<strong>reference data: 1.9</strong>).</li>
</ul>
<div class="markdown-heading"><h3 class="heading-element">2.4 Preparing OS</h3><a id="24-preparing-os" class="anchor" aria-label="Permalink: 2.4 Preparing OS" href="#24-preparing-os"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ul>
<li>
<p>Add an X-Road system administrator user (<strong>reference data: 1.3</strong>) whom all roles in the user interface are granted to. Add a new user with the command</p>
<pre><code>  sudo adduser &lt;username&gt;
</code></pre>
<p>User roles are discussed in detail in X-Road Security Server User Guide [<a href="#Ref_UG-SS">UG-SS</a>]. Do not use the user name <code>xroad</code>, it is reserved for the X-Road system user.</p>
</li>
<li>
<p>Set the operating system locale. Add following line to the <code>/etc/environment</code> file.</p>
<pre><code>  LC_ALL=en_US.UTF-8
</code></pre>
</li>
<li>
<p>Ensure that the packages <code>locales</code> and <code>software-properties-common</code> are present</p>
<pre><code>  sudo apt-get install locales software-properties-common
</code></pre>
</li>
<li>
<p>Ensure that the locale is available</p>
<pre><code>  sudo locale-gen en_US.UTF-8
</code></pre>
</li>
</ul>
<div class="markdown-heading"><h3 class="heading-element">2.5 Setup Package Repository</h3><a id="25-setup-package-repository" class="anchor" aria-label="Permalink: 2.5 Setup Package Repository" href="#25-setup-package-repository"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>Add the X-Road repository’s signing key to the list of trusted keys (<strong>reference data: 1.2</strong>):</p>
<div class="highlight highlight-source-shell"><pre>curl https://x-tee.ee/packages/test/xroad/xroad.pub <span class="pl-k">|</span> sudo gpg --dearmor -o /etc/apt/keyrings/xroad.gpg</pre></div>
<p>Add X-Road package repository (<strong>reference data: 1.1</strong>)</p>
<div class="highlight highlight-source-shell"><pre><span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>deb [signed-by=/etc/apt/keyrings/xroad.gpg] https://x-tee.ee/packages/test/xroad <span class="pl-s"><span class="pl-pds">$(</span>lsb_release -sc<span class="pl-pds">)</span></span>-current main<span class="pl-pds">"</span></span> <span class="pl-k">|</span> sudo tee /etc/apt/sources.list.d/xroad.list</pre></div>
<p>Update package repository metadata:</p>
<div class="highlight highlight-source-shell"><pre>sudo apt update</pre></div>
<p>If you are installing the default setup with local PostgreSQL database and want to enable the messagelog addon, continue at section 2.8. If you need to customize database properties and e.g. use a remote database or disable the messagelog addon, read on.</p>
<div class="markdown-heading"><h3 class="heading-element">2.6 Remote Database Setup (optional)</h3><a id="26-remote-database-setup-optional" class="anchor" aria-label="Permalink: 2.6 Remote Database Setup (optional)" href="#26-remote-database-setup-optional"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p><em>This is an optional step.</em></p>
<p>Optionally, the Security Server can use a remote database server. To avoid installing the default local PostgreSQL server during Security Server installation, first install the <code>xroad-database-remote</code> -package.</p>
<div class="highlight highlight-source-shell"><pre>sudo apt install xroad-database-remote</pre></div>
<p>For the application level backup and restore feature to work correctly, it is important to verify that the local PostgreSQL client has the same or later major version than the remote database server and, if necessary, install a different version of the <code>postgresql-client</code> package (see <a href="https://www.postgresql.org/download/linux/ubuntu/" rel="nofollow">https://www.postgresql.org/download/linux/ubuntu/</a>)</p>
<div class="highlight highlight-source-shell"><pre>psql --version
psql (PostgreSQL) 12.6 (Ubuntu 12.6-0ubuntu0.20.04.1)

psql -h <span class="pl-k">&lt;</span>database host<span class="pl-k">&gt;</span> -U <span class="pl-k">&lt;</span>superuser<span class="pl-k">&gt;</span> -tAc <span class="pl-s"><span class="pl-pds">'</span>show server_version<span class="pl-pds">'</span></span>
10.16 (Ubuntu 10.16-0ubuntu0.18.04.1)</pre></div>
<p>The Security Server installer can create the database and users for you, but you need to create a configuration file containing the database administrator credentials.</p>
<p>For advanced setup, e.g. when using separate servers for the databases, sharing a database with several Security Servers, or if storing the database administrator password on the Security Server is not an option, you can create the database users and structure manually as described in <a href="#annex-d-create-database-structure-manually">Annex D Create Database Structure Manually</a> and then continue to section 2.7. Otherwise, perform the following steps:</p>
<p>Create the property file:</p>
<div class="highlight highlight-source-shell"><pre>sudo touch /etc/xroad.properties
sudo chown root:root /etc/xroad.properties
sudo chmod 600 /etc/xroad.properties</pre></div>
<p>Edit <code>/etc/xroad.properties</code>. See the example below. Replace parameter values with your own.</p>
<div class="highlight highlight-source-ini"><pre><span class="pl-k">postgres.connection.password</span> = &lt;database superuser password&gt;
<span class="pl-k">postgres.connection.user</span> = &lt;database superuser name, postgres by default&gt;</pre></div>
<p>Note. If Microsoft Azure database for PostgreSQL is used, the connection user needs to be in format <code>username@hostname</code>.</p>
<p>Before continuing, test that the connection to the database works, e.g.</p>
<div class="highlight highlight-source-shell"><pre>psql -h <span class="pl-k">&lt;</span>database host<span class="pl-k">&gt;</span> -U <span class="pl-k">&lt;</span>superuser<span class="pl-k">&gt;</span> -tAc <span class="pl-s"><span class="pl-pds">'</span>show server_version<span class="pl-pds">'</span></span></pre></div>
<p>For additional security, the <code>postgresql.connection.*</code> properties can be removed from the <code>/etc/xroad.properties</code> file after installation (keep the other properties added by the installer).</p>
<div class="markdown-heading"><h3 class="heading-element">2.7 Disable the Messagelog Addon before Installation (optional)</h3><a id="27-disable-the-messagelog-addon-before-installation-optional" class="anchor" aria-label="Permalink: 2.7 Disable the Messagelog Addon before Installation (optional)" href="#27-disable-the-messagelog-addon-before-installation-optional"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>It is possible to preconfigure the Security Server installation so that the messagelog addon will be automatically disabled after the installation process is done. This also skips the creation of the messagelog database.</p>
<p>In order to skip messagelog database creation and disable the messagelog addon, run the following command to add a boolean value into the debconf database before installing the Security Server</p>
<div class="highlight highlight-source-shell"><pre>sudo debconf-set-selections <span class="pl-k">&lt;&lt;&lt;</span> <span class="pl-s"><span class="pl-pds">'</span>xroad-addon-messagelog xroad-addon-messagelog/enable-messagelog boolean false<span class="pl-pds">'</span></span></pre></div>
<div class="markdown-heading"><h3 class="heading-element">2.8 Security Server Installation</h3><a id="28-security-server-installation" class="anchor" aria-label="Permalink: 2.8 Security Server Installation" href="#28-security-server-installation"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>Issue the following command to install the Security Server packages (use package <code>xroad-securityserver-ee</code> to include configuration specific to Estonia; use package <code>xroad-securityserver-fi</code> to include configuration specific to Finland; use package <code>xroad-securityserver-is</code> to include configuration specific to Iceland):</p>
<div class="highlight highlight-source-shell"><pre>sudo apt update
sudo apt install xroad-securityserver</pre></div>
<p>Upon the first installation of the packages, the system asks for the following information.</p>
<ul>
<li>
<p>Account name for the user who will be granted the rights to perform all activities in the user interface (<strong>reference data: 1.3</strong>).</p>
</li>
<li>
<p>Database server URL. Locally installed database is suggested as default but remote databases can be used as well. In case remote database is used, one should verify that the version of the local PostgreSQL client matches the version of the remote PostgreSQL server.</p>
</li>
<li>
<p>The Distinguished Name of the owner of the <strong>user interface's and management REST API's</strong> self-signed TLS certificate (<em>Subject DN</em>) and its alternative names (<em>subjectAltName</em>) (<strong>reference data: 1.8; 1.10</strong>). The certificate is used for securing connections to the user interface and to the management REST API.
The name and IP addresses detected from the operating system are suggested as default values.</p>
<ul>
<li>
<p>The <em>Subject DN</em> must be entered in the format:</p>
<pre><code>    /CN=server.domain.tld
</code></pre>
</li>
<li>
<p>All IP addresses and domain names in use must be entered as alternative names in the format:</p>
<pre><code>    IP:1.2.3.4,IP:4.3.2.1,DNS:servername,DNS:servername2.domain.tld
</code></pre>
</li>
</ul>
</li>
<li>
<p>The Distinguished Name of the owner of the TLS certificate that is used for securing the HTTPS access point of information systems (<strong>reference data: 1.8; 1.11</strong>).
The name and IP addresses detected from the system are suggested as default values.</p>
<ul>
<li>
<p>The <em>Subject DN</em> must be entered in the format:</p>
<pre><code>  /CN=server.domain.tld
</code></pre>
</li>
<li>
<p>All IP addresses and domain names in use must be entered as alternative names in the format:</p>
<pre><code>  IP:1.2.3.4,IP:4.3.2.1,DNS:servername,DNS:servername2.domain.tld
</code></pre>
</li>
</ul>
</li>
</ul>
<p>The meta-package <code>xroad-securityserver</code> also installs metaservices module <code>xroad-addon-metaservices</code>, messagelog module <code>xroad-addon-messagelog</code> and WSDL validator module <code>xroad-addon-wsdlvalidator</code>. The meta-packages <code>xroad-securityserver-ee</code>, <code>xroad-securityserver-fi</code>, <code>xroad-securityserver-is</code>, and <code>xroad-securityserver-fo</code> install operational data monitoring module <code>xroad-addon-opmonitoring</code>.</p>
<p><strong>N.B.</strong> In case configuration specific to Estonia (package <code>xroad-securityserver-ee</code>) is installed, connections from client applications are restricted to localhost by default. To enable client application connections from external sources, the value of the <code>connector-host</code> property must be overridden in the <code>/etc/xroad/conf.d/local.ini</code> configuration file. Changing the system parameter values is explained in the System Parameters User Guide [<a href="#Ref_UG-SS">UG-SS</a>].</p>
<div class="markdown-heading"><h3 class="heading-element">2.9 Post-Installation Checks</h3><a id="29-post-installation-checks" class="anchor" aria-label="Permalink: 2.9 Post-Installation Checks" href="#29-post-installation-checks"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>The installation is successful if system services are started and the user interface is responding.</p>
<ul>
<li>Ensure from the command line that X-Road services are in the <code>running</code> state (example output follows):
<div class="highlight highlight-source-shell"><pre>sudo systemctl list-units <span class="pl-s"><span class="pl-pds">"</span>xroad-*<span class="pl-pds">"</span></span>

UNIT                           LOAD   ACTIVE SUB     DESCRIPTION
xroad-addon-messagelog.service loaded active running X-Road Messagelog Archiver
xroad-base.service             loaded active exited  X-Road initialization
xroad-confclient.service       loaded active running X-Road confclient
xroad-monitor.service          loaded active running X-Road Monitor
xroad-proxy-ui-api.service     loaded active running X-Road Proxy UI REST API
xroad-proxy.service            loaded active running X-Road Proxy
xroad-signer.service           loaded active running X-Road signer</pre></div>
</li>
<li>Ensure that the Security Server user interface at <a href="https://SECURITYSERVER:4000/" rel="nofollow">https://SECURITYSERVER:4000/</a> (<strong>reference data: 1.8; 1.6</strong>) can be opened in a Web browser. To log in, use the account name chosen during the installation (<strong>reference data: 1.3</strong>). While the user interface is still starting up, the Web browser may display a connection refused -error.</li>
</ul>
<div class="markdown-heading"><h3 class="heading-element">2.10 Installing the Support for Hardware Tokens</h3><a id="210-installing-the-support-for-hardware-tokens" class="anchor" aria-label="Permalink: 2.10 Installing the Support for Hardware Tokens" href="#210-installing-the-support-for-hardware-tokens"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>To configure support for hardware security tokens (smartcard, USB token, Hardware Security Module), act as follows.</p>
<ol>
<li>
<p>Install the hardware token support module using the following command:</p>
<pre><code>sudo apt-get install xroad-addon-hwtokens
</code></pre>
</li>
<li>
<p>Install and configure a PKCS#11 driver for the hardware token according to the manufacturer's instructions.</p>
</li>
<li>
<p>Add the path to the PKCS#11 driver to the file <code>/etc/xroad/devices.ini</code> (as described in the example given in the file).</p>
</li>
<li>
<p>After installing and configuring the driver, the <code>xroad-signer</code> service must be restarted:</p>
<pre><code>sudo service xroad-signer restart
</code></pre>
</li>
</ol>
<p>If you are running a high availability (HA) hardware token setup (such as a cluster with replicated tokens) then you may need to constrain the token identifier format such that the token replicas can be seen as the same token. The token identifier format can be changed in <code>/etc/xroad/devices.ini</code> via the <code>token_id_format</code> property (default value: <code>{moduleType}{slotIndex}{serialNumber}{label}</code>). Removing certain parts of the identifier will allow the HA setup to work correctly when one of the tokens goes down and is replaced by a replica. For example, if the token replicas are reported to be on different slots the <code>{slotIndex}</code> part should be removed from the identifier format.</p>
<p>Depending on the hardware token there may be a need for more additional configuration. All possible configurable parameters in the <code>/etc/xroad/devices.ini</code> are described in the next table.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Default Value</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>enabled</em></td>
<td>BOOLEAN</td>
<td><em>true</em></td>
<td>Indicates whether this device is enabled.</td>
</tr>
<tr>
<td><em>library</em></td>
<td>STRING</td>
<td></td>
<td>The path to the pkcs#11 library of the device driver.</td>
</tr>
<tr>
<td><em>library_cant_create_os_threads</em></td>
<td>BOOLEAN</td>
<td><em>false</em></td>
<td>Indicates whether application threads, which are executing calls to the pkcs#11 library, may not use native operating system calls to spawn new threads (in other words, the library’s code may not create its own threads).</td>
</tr>
<tr>
<td><em>os_locking_ok</em></td>
<td>BOOLEAN</td>
<td><em>false</em></td>
<td>Indicates whether the pkcs#11 library may use the native operation system threading model for locking.</td>
</tr>
<tr>
<td><em>sign_verify_pin</em></td>
<td>BOOLEAN</td>
<td><em>false</em></td>
<td>Indicates whether the PIN should be entered per signing operation.</td>
</tr>
<tr>
<td><em>token_id_format</em></td>
<td>STRING</td>
<td><em>{moduleType}{slotIndex}{serialNumber}{label}</em></td>
<td>Specifies the identifier format used to uniquely identify a token. In certain high availability setups may need be constrained to support replicated tokens (eg. by removing the slot index part which may be diffirent for the token replicas).</td>
</tr>
<tr>
<td><em>sign_mechanism</em></td>
<td>STRING</td>
<td><em>CKM_RSA_PKCS</em></td>
<td>Specifies the signing mechanism. Supported values: <em>CKM_RSA_PKCS</em>, <em>CKM_RSA_PKCS_PSS</em>.</td>
</tr>
<tr>
<td><em>pub_key_attribute_encrypt</em></td>
<td>BOOLEAN</td>
<td><em>true</em></td>
<td>Indicates whether public key can be used for encryption.</td>
</tr>
<tr>
<td><em>pub_key_attribute_verify</em></td>
<td>BOOLEAN</td>
<td><em>true</em></td>
<td>Indicates whether public key can be used for verification.</td>
</tr>
<tr>
<td><em>pub_key_attribute_wrap</em></td>
<td>BOOLEAN</td>
<td></td>
<td>Indicates whether public key can be used for wrapping other keys.</td>
</tr>
<tr>
<td><em>pub_key_attribute_allowed_mechanisms</em></td>
<td>STRING LIST</td>
<td></td>
<td>Specifies public key allowed mechanisms. Supported values: <em>CKM_RSA_PKCS</em>, <em>CKM_SHA256_RSA_PKCS</em>, <em>CKM_SHA384_RSA_PKCS</em>, <em>CKM_SHA512_RSA_PKCS</em>, and <em>CKM_RSA_PKCS_PSS</em>, <em>CKM_SHA256_RSA_PKCS_PSS</em>, <em>CKM_SHA384_RSA_PKCS_PSS</em>, <em>CKM_SHA512_RSA_PKCS_PSS</em>.</td>
</tr>
<tr>
<td><em>priv_key_attribute_sensitive</em></td>
<td>BOOLEAN</td>
<td><em>true</em></td>
<td>Indicates whether private key is sensitive.</td>
</tr>
<tr>
<td><em>priv_key_attribute_decrypt</em></td>
<td>BOOLEAN</td>
<td><em>true</em></td>
<td>Indicates whether private key can be used for encryption.</td>
</tr>
<tr>
<td><em>priv_key_attribute_sign</em></td>
<td>BOOLEAN</td>
<td><em>true</em></td>
<td>Indicates whether private key can be used for signing.</td>
</tr>
<tr>
<td><em>priv_key_attribute_unwrap</em></td>
<td>BOOLEAN</td>
<td></td>
<td>Indicates whether private key can be used for unwrapping wrapped keys.</td>
</tr>
<tr>
<td><em>priv_key_attribute_allowed_mechanisms</em></td>
<td>STRING LIST</td>
<td></td>
<td>Specifies private key allowed mechanisms. Supported values: <em>CKM_RSA_PKCS</em>, <em>CKM_SHA256_RSA_PKCS</em>, <em>CKM_SHA384_RSA_PKCS</em>, <em>CKM_SHA512_RSA_PKCS</em>, and <em>CKM_RSA_PKCS_PSS</em>, <em>CKM_SHA256_RSA_PKCS_PSS</em>, <em>CKM_SHA384_RSA_PKCS_PSS</em>, <em>CKM_SHA512_RSA_PKCS_PSS</em>.</td>
</tr>
</tbody>
</table>
<p><strong>Note 1:</strong> Only parameter <em>library</em> is mandatory, all the others are optional.
<strong>Note 2:</strong> The item separator of the type STRING LIST is ",".</p>
<div class="markdown-heading"><h3 class="heading-element">2.11 Installing the Support for Environmental Monitoring</h3><a id="211-installing-the-support-for-environmental-monitoring" class="anchor" aria-label="Permalink: 2.11 Installing the Support for Environmental Monitoring" href="#211-installing-the-support-for-environmental-monitoring"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>The support for environmental monitoring functionality on a Security Server is provided by package xroad-monitor that is installed by default. The package installs and starts the <code>xroad-monitor</code> process that will gather and make available the monitoring information.</p>
<div class="markdown-heading"><h2 class="heading-element">3 Security Server Initial Configuration</h2><a id="3-security-server-initial-configuration" class="anchor" aria-label="Permalink: 3 Security Server Initial Configuration" href="#3-security-server-initial-configuration"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>During the Security Server initial configuration, the server’s X-Road membership information and the software token’s PIN are set.</p>
<div class="markdown-heading"><h3 class="heading-element">3.1 Prerequisites</h3><a id="31-prerequisites" class="anchor" aria-label="Permalink: 3.1 Prerequisites" href="#31-prerequisites"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>Configuring the Security Server assumes that the Security Server owner is a member of the X-Road.</p>
<div class="markdown-heading"><h3 class="heading-element">3.2 Reference Data</h3><a id="32-reference-data" class="anchor" aria-label="Permalink: 3.2 Reference Data" href="#32-reference-data"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>ATTENTION: Reference items 2.1 - 2.3 in the reference data are provided to the Security Server owner by the X-Road central’s administrator.</p>
<p>The Security Server code and the software token’s PIN will be determined during the installation at the latest, by the person performing the installation.</p>
<table>
<thead>
<tr>
<th>Ref</th>
<th></th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.1</td>
<td>
<a href="https://x-tee.ee/anchors/" rel="nofollow">https://x-tee.ee/anchors/</a>&lt;anchor file&gt;<br> ee-dev - development environment<br> ee-test - test environment<br> EE - production environment</td>
<td>Global configuration anchor file</td>
</tr>
<tr>
<td>2.2</td>
<td>GOV - government<br> COM - commercial<br> NGO - non-profit<br> NEE - not Estonian</td>
<td>Member class of the security server's owner</td>
</tr>
<tr>
<td>2.3</td>
<td>&lt;security server owner register code&gt;</td>
<td>Member code of the security server's owner</td>
</tr>
<tr>
<td>2.4</td>
<td>&lt;choose security server identificator name&gt;</td>
<td>Security server's code</td>
</tr>
<tr>
<td>2.5</td>
<td>&lt;choose PIN for software token&gt;</td>
<td>Software token’s PIN</td>
</tr>
</tbody>
</table>
<div class="markdown-heading"><h3 class="heading-element">3.3 Configuration</h3><a id="33-configuration" class="anchor" aria-label="Permalink: 3.3 Configuration" href="#33-configuration"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>To perform the initial configuration, open the address</p>
<pre><code>https://SECURITYSERVER:4000/
</code></pre>
<p>in a Web browser (<strong>reference data: 1.8; 1.6</strong>). To log in, use the account name chosen during the installation (<strong>reference data: 1.3).</strong></p>
<p>Upon first log-in, the system asks for the following information.</p>
<ul>
<li>
<p>The global configuration anchor file (<strong>reference data: 2.1</strong>).</p>
<p><strong>Please verify anchor hash value with the published value.</strong></p>
</li>
</ul>
<p>If the configuration is successfully downloaded, the system asks for the following information.</p>
<ul>
<li>
<p>The Security Server owner’s member class (<strong>reference data: 2.2</strong>).</p>
</li>
<li>
<p>The Security Server owner’s member code (<strong>reference data: 2.3</strong>).</p>
<p>If the member class and member code are correctly entered, the system displays the Security Server owner’s name as registered in the X-Road center.</p>
</li>
<li>
<p>Security server code (<strong>reference data: 2.4</strong>), which is chosen by the Security Server administrator and which has to be unique across all the Security Servers belonging to the same X-Road member.</p>
</li>
<li>
<p>Software token’s PIN (<strong>reference data: 2.5</strong>). The PIN will be used to protect the keys stored in the software token. The PIN must be stored in a secure place, because it will be no longer possible to use or recover the private keys in the token once the PIN has been lost.</p>
</li>
</ul>
<div class="markdown-heading"><h3 class="heading-element">3.4 Configuring firewall</h3><a id="34-configuring-firewall" class="anchor" aria-label="Permalink: 3.4 Configuring firewall" href="#34-configuring-firewall"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>It is strongly recommended to protect the Security Server from unwanted access using a firewall (hardware or software based). The firewall can be
applied to both incoming and outgoing connections depending on the security requirements of the environment where the Security Server is deployed.</p>
<p><strong>Special attention should be paid with the firewall configuration since incorrect configuration may leave the Security Server vulnerable to exploits and attacks.</strong>
This type of abuse could result in compromised access to the Security Server and the data that is exchanged through it.</p>
<p>It is recommended to allow incoming traffic to specific ports only from explicitly defined sources using IP filtering. Access for ports <code>8080</code>, <code>8443</code> and <code>4000</code>
should be especially defined, as these ports are used for making X-Road queries and accessing the user interface.</p>
<p>When installing the Security Server, it is strongly recommended to look over the list of ports at <a href="#22-reference-data">2.2 Reference Data</a> and define
firewall access rules for specific hosts based on their descriptions.</p>
<div class="markdown-heading"><h4 class="heading-element">3.4.1 Accepting Connections</h4><a id="341-accepting-connections" class="anchor" aria-label="Permalink: 3.4.1 Accepting Connections" href="#341-accepting-connections"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>The Security Server has a special <code>[proxy]</code> parameter <a href="ug-syspar_x-road_v6_system_parameters.html#32-proxy-parameters-proxy">connector-host</a> which determines
the interfaces that the Security Server uses to listen for incoming connections. The default value for this parameter in the default X-Road packages is <code>0.0.0.0</code>,
which makes the Security Server accept connections from any server. For country-specific defaults, please refer to the system parameters documentation.</p>
<p>The parameter can be changed by following the <a href="ug-syspar_x-road_v6_system_parameters.html#21-changing-the-system-parameter-values-in-configuration-files">System Parameters guide</a>.</p>
<div class="markdown-heading"><h3 class="heading-element">3.5 Configuring configuration backup encryption</h3><a id="35-configuring-configuration-backup-encryption" class="anchor" aria-label="Permalink: 3.5 Configuring configuration backup encryption" href="#35-configuring-configuration-backup-encryption"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>It is possible to automatically encrypt Security Server configuration backups. Security server uses The GNU Privacy Guard (<a href="https://www.gnupg.org" rel="nofollow">https://www.gnupg.org</a>)
for backup encryption and verification. Backups are always signed, but backup encryption is initially turned off.
To turn encryption on, please override the default configuration in the file <code>/etc/xroad/conf.d/local.ini</code>, in the <code>[proxy]</code> section (add or edit this section).</p>
<pre><code>[proxy]
backup-encryption-enabled = true
backup-encryption-keyids = &lt;keyid1&gt;, &lt;keyid2&gt;, ...
</code></pre>
<p>To turn backup encryption on, please change the <code>backup-encryption-enabled</code> property value to <code>true</code>.
By default, backups are encrypted using Security Server's backup encryption key. Additional encryption keys can be imported in the /etc/xroad/gpghome keyring and key identifiers listed using the backup-encryption-keyids parameter. It is recommended to set up at least one additional key, otherwise the backups will be unusable in case Security Server's private key is lost. It is up to Security Server's administrator to check that keys used are sufficiently strong, there are no automatic checks.</p>
<p>Warning. All keys listed in backup-encryption-keyids must be present in the gpg keyring or backup fails.</p>
<p>All these keys are used to encrypt backups so that ANY of these keys can decrypt the backups. This is useful both for verifying encrypted backups'
consistency and decrypting backups in case Security Server's backup encryption key gets lost for whatever reason.</p>
<p>To externally verify a backup archive's consistency, Security Server's backup encryption public key has to be exported
and imported into external GPG keyring. Note that this can be done only after Security Server has been initialised - the
Security Server backup encryption key is generated during initialisation.</p>
<p>To export Security Server's backup encryption public key use the following command:</p>
<pre><code>gpg --homedir /etc/xroad/gpghome --armor --output server-public-key.gpg --export AA/GOV/TS1OWNER/TS1
</code></pre>
<p>where <code>AA/GOV/TS1OWNER/TS1</code> is the Security Server id.</p>
<p>The key can then be moved to an external host and imported to GPG keyring with the following command:</p>
<pre><code>gpg --homedir /your_gpg_homedir_here --import server-public-key.gpg
</code></pre>
<div class="markdown-heading"><h2 class="heading-element">4 Installation Error handling</h2><a id="4-installation-error-handling" class="anchor" aria-label="Permalink: 4 Installation Error handling" href="#4-installation-error-handling"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="markdown-heading"><h3 class="heading-element">4.1 Cannot Set LC_ALL to Default Locale</h3><a id="41-cannot-set-lc_all-to-default-locale" class="anchor" aria-label="Permalink: 4.1 Cannot Set LC_ALL to Default Locale" href="#41-cannot-set-lc_all-to-default-locale"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>If running the locale command results in the error message</p>
<pre><code>locale: Cannot set LC_ALL to default locale: No such file or directory,
</code></pre>
<p>then the support for this particular language has not been installed. To install it, run the command (the example uses the English language):</p>
<pre><code>sudo apt-get install language-pack-en
</code></pre>
<p>Then, to update the system’s locale files, run the following commands (the example uses the US locale):</p>
<pre><code>sudo locale-gen en_US.UTF-8
sudo update-locale en_US.UTF-8
</code></pre>
<p>Set operating system locale. Add following line to <code>/etc/environment</code> file:</p>
<pre><code>LC_ALL=en_US.UTF-8
</code></pre>
<p>After updating the system’s locale settings, it is recommended to restart the operating system.</p>
<div class="markdown-heading"><h3 class="heading-element">4.2 PostgreSQL Is Not UTF8 Compatible</h3><a id="42-postgresql-is-not-utf8-compatible" class="anchor" aria-label="Permalink: 4.2 PostgreSQL Is Not UTF8 Compatible" href="#42-postgresql-is-not-utf8-compatible"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>If the Security Server installation is aborted with the error message</p>
<pre><code>postgreSQL is not UTF8 compatible,
</code></pre>
<p>then the PostgreSQL package is installed with a wrong locale. One way to resolve it is to remove the data store created upon the PostgreSQL installation and recreate it with the correct encoding.</p>
<p><strong>WARNING</strong>: All data in the database will be erased!</p>
<pre><code>sudo pg_dropcluster --stop 10 main
LC_ALL="en_US.UTF-8" sudo pg_createcluster --start 10 main
</code></pre>
<p>To complete the interrupted installation, run the command</p>
<pre><code>sudo apt-get -f install
</code></pre>
<div class="markdown-heading"><h3 class="heading-element">4.3 Could Not Create Default Cluster</h3><a id="43-could-not-create-default-cluster" class="anchor" aria-label="Permalink: 4.3 Could Not Create Default Cluster" href="#43-could-not-create-default-cluster"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>If the following error message is displayed during PostgreSQL installation:</p>
<pre><code>Error: The locale requested by the environment is invalid.
Error: could not create default cluster. Please create it manually with pg_createcluster 10 main –start,
</code></pre>
<p>use the following command to create the PostgreSQL data cluster:</p>
<pre><code>LC_ALL="en_US.UTF-8" sudo pg_createcluster --start 10 main
</code></pre>
<p>The interrupted installation can be finished using</p>
<pre><code>sudo apt-get -f install
</code></pre>
<div class="markdown-heading"><h3 class="heading-element">4.4 Is Postgres Running On Port 5432?</h3><a id="44-is-postgres-running-on-port-5432" class="anchor" aria-label="Permalink: 4.4 Is Postgres Running On Port 5432?" href="#44-is-postgres-running-on-port-5432"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>If the following error message appears during installation</p>
<pre><code>Is postgres running on port 5432 ?
Aborting installation! please fix issues and rerun with apt-get -f install,
</code></pre>
<p>check if any of the following errors occurred during the installation of PostgreSQL.</p>
<ul>
<li>
<p>Error installing the data cluster. Refer to section <a href="#43-could-not-create-default-cluster">“Could not create default cluster”</a>.</p>
</li>
<li>
<p>The PostgreSQL data cluster installed during the installation of the Security Server is not configured to listen on port 5432. To verify and configure the listening port, edit the PostgreSQL configuration file in <code>/etc/postgresql/10/main/postgresql.conf</code>. If you change the listening port, the postgresql service must be restarted.</p>
</li>
</ul>
<p>The interrupted installation can be finished using</p>
<pre><code>sudo apt-get -f install
</code></pre>
<div class="markdown-heading"><h3 class="heading-element">4.5 Different versions of xroad-* packages after successful upgrade</h3><a id="45-different-versions-of-xroad--packages-after-successful-upgrade" class="anchor" aria-label="Permalink: 4.5 Different versions of xroad-* packages after successful upgrade" href="#45-different-versions-of-xroad--packages-after-successful-upgrade"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>Sometimes, after using <code>sudo apt-get upgrade</code> command, some of the packages are not upgraded. In the following example <code>xroad-securityserver</code> package version is still 6.8.3 although other packages are upgraded to 6.8.5:</p>
<pre><code># sudo dpkg -l | grep xroad-
ii xroad-addon-messagelog 6.8.5.20160929134539gitfe60f90
ii xroad-addon-metaservices 6.8.5.20160929134539gitfe60f90
ii xroad-addon-wsdlvalidator 6.8.5.20160929134539gitfe60f90
ii xroad-common 6.8.5.20160929134539gitfe60f90
ii xroad-jetty9 6.8.5.20160929134539gitfe60f90
ii xroad-proxy 6.8.5.20160929134539gitfe60f90
ii xroad-securityserver-ee 6.8.3-3-201605131138
</code></pre>
<p><code>apt-get upgrade</code> command doesn’t install new packages - in this particular case new packages <code>xroad-monitor</code> and <code>xroad-addon-proxymonitor</code> installation is needed for upgrade of <code>xroad-securityserver</code> package.</p>
<p>To be sure that packages are installed correctly please use <code>sudo apt upgrade</code> or <code>sudo apt full-upgrade</code> commands.</p>
<div class="markdown-heading"><h3 class="heading-element">4.6 ERROR: Upgrade supported from version X.Y.Z or newer</h3><a id="46-error-upgrade-supported-from-version-xyz-or-newer" class="anchor" aria-label="Permalink: 4.6 ERROR: Upgrade supported from version X.Y.Z or newer" href="#46-error-upgrade-supported-from-version-xyz-or-newer"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>The following error message may come up during the Security Server upgrade.</p>
<p><code>ERROR: Upgrade supported from version X.Y.Z or newer</code></p>
<p>Upgrading the packages from the current version to the target version is not supported directly. The fix is to upgrade the Security Server to the target version step by step.</p>
<p>A guide to upgrading from an older version of X-Road can be found <a href="https://abi.ria.ee/xtee/en/turvaserveri-haldus/turvaserveri-uuendamine" rel="nofollow">here</a>. Follow the chapter which contains your current X-Road version.</p>
<div class="markdown-heading"><h2 class="heading-element">Annex A Security Server Default Database Properties</h2><a id="annex-a-security-server-default-database-properties" class="anchor" aria-label="Permalink: Annex A Security Server Default Database Properties" href="#annex-a-security-server-default-database-properties"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p><code>/etc/xroad/db.properties</code></p>
<div class="highlight highlight-source-ini"><pre><span class="pl-c"><span class="pl-c">#</span> connection.url format: jdbc:postgresql://&lt;hostname&gt;:&lt;port&gt;/&lt;database name&gt;</span>

<span class="pl-k">serverconf.hibernate.connection.url</span> = jdbc:postgresql://127.0.0.1:5432/serverconf
<span class="pl-k">serverconf.hibernate.connection.username</span> = serverconf
<span class="pl-k">serverconf.hibernate.connection.password</span> = &lt;randomly generated password&gt;
<span class="pl-k">serverconf.hibernate.connection.driver_class</span> = org.postgresql.Driver
<span class="pl-k">serverconf.hibernate.dialect</span> = ee.ria.xroad.common.db.CustomPostgreSQLDialect
<span class="pl-k">serverconf.hibernate.hikari.dataSource.currentSchema</span> = serverconf,public
<span class="pl-k">serverconf.hibernate.jdbc.use_streams_for_binary</span> = true

<span class="pl-k">messagelog.hibernate.connection.url</span> = jdbc:postgresql://127.0.0.1:5432/messagelog
<span class="pl-k">messagelog.hibernate.connection.username</span> = messagelog
<span class="pl-k">messagelog.hibernate.connection.password</span> = &lt;randomly generated password&gt;
<span class="pl-k">messagelog.hibernate.connection.driver_class</span> = org.postgresql.Driver
<span class="pl-k">messagelog.hibernate.dialect</span> = ee.ria.xroad.common.db.CustomPostgreSQLDialect
<span class="pl-k">messagelog.hibernate.hikari.dataSource.currentSchema</span> = messagelog,public
<span class="pl-k">messagelog.hibernate.jdbc.use_streams_for_binary</span> = true

<span class="pl-k">op-monitor.hibernate.connection.url</span> = jdbc:postgresql://127.0.0.1:5432/op-monitor
<span class="pl-k">op-monitor.hibernate.connection.username</span> = opmonitor
<span class="pl-k">op-monitor.hibernate.connection.password</span> = &lt;randomly generated password&gt;
<span class="pl-k">op-monitor.hibernate.connection.driver_class</span> = org.postgresql.Driver
<span class="pl-k">op-monitor.hibernate.hikari.dataSource.currentSchema</span> = opmonitor,public
<span class="pl-k">op-monitor.hibernate.jdbc.use_streams_for_binary</span> = true</pre></div>
<div class="markdown-heading"><h2 class="heading-element">Annex B Default Database Users</h2><a id="annex-b-default-database-users" class="anchor" aria-label="Permalink: Annex B Default Database Users" href="#annex-b-default-database-users"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<table>
<thead>
<tr>
<th>User</th>
<th>Database</th>
<th>Privileges</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>serverconf</td>
<td>serverconf</td>
<td>TEMPORARY,CONNECT</td>
<td>The database user used to read/write the serverconf database during application runtime.</td>
</tr>
<tr>
<td>serverconf_admin</td>
<td>serverconf</td>
<td>CREATE,TEMPORARY,CONNECT</td>
<td>The database user used to create/update the serverconf schema.</td>
</tr>
<tr>
<td>messagelog</td>
<td>messagelog</td>
<td>TEMPORARY,CONNECT</td>
<td>The database user used to read/write the messagelog database during application runtime.</td>
</tr>
<tr>
<td>messagelog_admin</td>
<td>messagelog</td>
<td>CREATE,TEMPORARY,CONNECT</td>
<td>The database user used to create/update the messagelog schema.</td>
</tr>
<tr>
<td>opmonitor</td>
<td>op-monitor</td>
<td>TEMPORARY,CONNECT</td>
<td>The database user used to read/write the op-monitor database during application runtime.</td>
</tr>
<tr>
<td>opmonitor_admin</td>
<td>op-monitor</td>
<td>CREATE,TEMPORARY,CONNECT</td>
<td>The database user used to create/update the op-monitor schema.</td>
</tr>
<tr>
<td>postgres</td>
<td>ALL</td>
<td>ALL</td>
<td>PostgreSQL database default superuser.</td>
</tr>
</tbody>
</table>
<div class="markdown-heading"><h2 class="heading-element">Annex C Deployment Options</h2><a id="annex-c-deployment-options" class="anchor" aria-label="Permalink: Annex C Deployment Options" href="#annex-c-deployment-options"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<div class="markdown-heading"><h3 class="heading-element">C.1 General</h3><a id="c1-general" class="anchor" aria-label="Permalink: C.1 General" href="#c1-general"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>X-Road Security Server has multiple deployment options. The simplest choice is to have a single Security Server with local database. This is usually fine for majority of the cases, but there are multiple reasons to tailor the deployment.</p>
<div class="markdown-heading"><h3 class="heading-element">C.2 Local Database</h3><a id="c2-local-database" class="anchor" aria-label="Permalink: C.2 Local Database" href="#c2-local-database"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>The simplest deployment option is to use a single Security Server with local database. For development and testing purposes there is rarely need for anything else, but for production the requirements may be stricter.</p>
<p><a target="_blank" rel="noopener noreferrer" href="img/ig-ss_local_db.svg"><img src="img/ig-ss_local_db.svg" alt="Security server with local database" style="max-width: 100%;"></a></p>
<div class="markdown-heading"><h3 class="heading-element">C.3 Remote Database</h3><a id="c3-remote-database" class="anchor" aria-label="Permalink: C.3 Remote Database" href="#c3-remote-database"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>It is possible to use a remote database with Security Server. This option is sometimes used in development and testing when there's need to externalize the database state.</p>
<p>Security server supports a variety of cloud databases including AWS RDS and Azure Database for PostgreSQL. This deployment option is useful when doing development in cloud environment, where use of cloud native database is the first choice.</p>
<p><a target="_blank" rel="noopener noreferrer" href="img/ig-ss_remote_db.svg"><img src="img/ig-ss_remote_db.svg" alt="Security server with remote database" style="max-width: 100%;"></a></p>
<div class="markdown-heading"><h3 class="heading-element">C.4 High Availability Setup</h3><a id="c4-high-availability-setup" class="anchor" aria-label="Permalink: C.4 High Availability Setup" href="#c4-high-availability-setup"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>In production systems it's rarely acceptable to have a single point of failure. Security server supports provider side high availability setup via so called internal load balancing mechanism. The setup works so that the same member / member class / member code / subsystem / service code is configured on multiple Security Servers and X-Road will then route the request to the server that responds the fastest. Note that this deployment option does not provide performance benefits, just redundancy.</p>
<p><a target="_blank" rel="noopener noreferrer" href="img/ig-ss_high_availability.svg"><img src="img/ig-ss_high_availability.svg" alt="Security server high-availability setup" style="max-width: 100%;"></a></p>
<div class="markdown-heading"><h3 class="heading-element">C.5 Load Balancing Setup</h3><a id="c5-load-balancing-setup" class="anchor" aria-label="Permalink: C.5 Load Balancing Setup" href="#c5-load-balancing-setup"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>Busy production systems may need scalable performance in addition to high availability. X-Road supports external load balancing mechanism to address both of these problems simultaneously. A load balancer is added in front of a Security Server cluster to route the requests based on selected algorithm. This deployment option is extensively documented in [<a href="#Ref_IG-XLB">IG-XLB</a>].</p>
<p><a target="_blank" rel="noopener noreferrer" href="img/ig-ss_load_balancing.svg"><img src="img/ig-ss_load_balancing.svg" alt="Security server load balancing setup" style="max-width: 100%;"></a></p>
<div class="markdown-heading"><h3 class="heading-element">C.6 Summary</h3><a id="c6-summary" class="anchor" aria-label="Permalink: C.6 Summary" href="#c6-summary"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>The following table lists a summary of the Security Server deployment options and indicates whether they are aimed for development or production use.</p>
<table>
<thead>
<tr>
<th>Deployment</th>
<th>Dev</th>
<th>Prod</th>
</tr>
</thead>
<tbody>
<tr>
<td>Local database</td>
<td>x</td>
<td></td>
</tr>
<tr>
<td>Remote database</td>
<td>x</td>
<td></td>
</tr>
<tr>
<td>High-availability Setup</td>
<td></td>
<td>x</td>
</tr>
<tr>
<td>Load Balancing Setup</td>
<td></td>
<td>x</td>
</tr>
</tbody>
</table>
<div class="markdown-heading"><h2 class="heading-element">Annex D Create Database Structure Manually</h2><a id="annex-d-create-database-structure-manually" class="anchor" aria-label="Permalink: Annex D Create Database Structure Manually" href="#annex-d-create-database-structure-manually"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>Depending on installed components, the Security Server uses one to three databases (catalogs):</p>
<ul>
<li>
<em>serverconf</em> for storing Security Server configuration (required)</li>
<li>
<em>messagelog</em> for storing message records (optional, but installed by default)</li>
<li>
<em>op-monitor</em> for operational monitoring data (optional)</li>
</ul>
<p>These databases can be hosted on one database server (default setup), or you can use several servers.</p>
<p>Login to the database server(s) as the superuser (<code>postgres</code> by default) to run the commands, e.g.</p>
<div class="highlight highlight-source-shell"><pre>psql -h <span class="pl-k">&lt;</span>database host<span class="pl-k">&gt;</span>:<span class="pl-k">&lt;</span>port<span class="pl-k">&gt;</span> -U <span class="pl-k">&lt;</span>superuser<span class="pl-k">&gt;</span> -d postgres</pre></div>
<p>Run the following commands to create the necessary database structures.
If necessary, customize the database and role names to suit your environment (e.g when the same database server is shared between several Security Server instances, it is necessary to have separate database names and roles for each server).</p>
<p><strong>serverconf</strong> (required)</p>
<p>By default, the database, database user, and schema use the same name of <code>serverconf</code>, and the admin user is named with <code>_admin</code> suffix (e.g. <code>serverconf_admin</code>).</p>
<div class="highlight highlight-source-sql"><pre>CREATE DATABASE <span class="pl-k">&lt;</span>serverconf_database<span class="pl-k">&gt;</span> ENCODING <span class="pl-s"><span class="pl-pds">'</span>UTF8<span class="pl-pds">'</span></span>;
<span class="pl-k">REVOKE</span> ALL <span class="pl-k">ON</span> DATABASE <span class="pl-k">&lt;</span>serverconf_database<span class="pl-k">&gt;</span> <span class="pl-k">FROM</span> PUBLIC;
CREATE ROLE <span class="pl-k">&lt;</span>serverconf_admin_user<span class="pl-k">&gt;</span> LOGIN PASSWORD <span class="pl-s"><span class="pl-pds">'</span>&lt;serverconf_admin_user password&gt;<span class="pl-pds">'</span></span>;
<span class="pl-k">GRANT</span> <span class="pl-k">&lt;</span>serverconf_admin_user<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>superuser<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> CREATE,TEMPORARY,CONNECT <span class="pl-k">ON</span> DATABASE <span class="pl-k">&lt;</span>serverconf_database<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>serverconf_admin_user<span class="pl-k">&gt;</span>;
\c <span class="pl-k">&lt;</span>serverconf_database<span class="pl-k">&gt;</span>
CREATE EXTENSION hstore;
CREATE SCHEMA <span class="pl-k">&lt;</span>serverconf_schema<span class="pl-k">&gt;</span> AUTHORIZATION <span class="pl-k">&lt;</span>serverconf_admin_user<span class="pl-k">&gt;</span>;
<span class="pl-k">REVOKE</span> ALL <span class="pl-k">ON</span> SCHEMA public <span class="pl-k">FROM</span> PUBLIC;
<span class="pl-k">GRANT</span> USAGE <span class="pl-k">ON</span> SCHEMA public TO <span class="pl-k">&lt;</span>serverconf_admin_user<span class="pl-k">&gt;</span>;
CREATE ROLE <span class="pl-k">&lt;</span>serverconf_database_user<span class="pl-k">&gt;</span> LOGIN PASSWORD <span class="pl-s"><span class="pl-pds">'</span>&lt;serverconf_database_user password&gt;<span class="pl-pds">'</span></span>;
<span class="pl-k">GRANT</span> <span class="pl-k">&lt;</span>serverconf_database_user<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>superuser<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> TEMPORARY,CONNECT <span class="pl-k">ON</span> DATABASE <span class="pl-k">&lt;</span>serverconf_database<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>serverconf_database_user<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> USAGE <span class="pl-k">ON</span> SCHEMA public TO <span class="pl-k">&lt;</span>serverconf_database_user<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> USAGE <span class="pl-k">ON</span> SCHEMA <span class="pl-k">&lt;</span>serverconf_schema<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>serverconf_database_user<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> <span class="pl-k">SELECT</span>,<span class="pl-k">UPDATE</span>,INSERT,<span class="pl-k">DELETE</span> <span class="pl-k">ON</span> ALL TABLES <span class="pl-k">IN</span> SCHEMA <span class="pl-k">&lt;</span>serverconf_schema<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>serverconf_database_user<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> <span class="pl-k">SELECT</span>,<span class="pl-k">UPDATE</span> <span class="pl-k">ON</span> ALL SEQUENCES <span class="pl-k">IN</span> SCHEMA <span class="pl-k">&lt;</span>serverconf_schema<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>serverconf_database_user<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> EXECUTE <span class="pl-k">ON</span> ALL FUNCTIONS <span class="pl-k">IN</span> SCHEMA <span class="pl-k">&lt;</span>serverconf_schema<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>serverconf_database_user<span class="pl-k">&gt;</span>;</pre></div>
<p><strong>messagelog</strong> (required by xroad-addon-messagelog)</p>
<p>By default, the database, database user, and schema use the same name of <code>messagelog</code>, and the admin user is named with <code>_admin</code> suffix (e.g. <code>messagelog_admin</code>).</p>
<div class="highlight highlight-source-sql"><pre>CREATE DATABASE <span class="pl-k">&lt;</span>messagelog_database<span class="pl-k">&gt;</span> ENCODING <span class="pl-s"><span class="pl-pds">'</span>UTF8<span class="pl-pds">'</span></span>;
<span class="pl-k">REVOKE</span> ALL <span class="pl-k">ON</span> DATABASE <span class="pl-k">&lt;</span>messagelog_database<span class="pl-k">&gt;</span> <span class="pl-k">FROM</span> PUBLIC;
CREATE ROLE <span class="pl-k">&lt;</span>messagelog_admin_user<span class="pl-k">&gt;</span> LOGIN PASSWORD <span class="pl-s"><span class="pl-pds">'</span>&lt;messagelog_admin_user password&gt;<span class="pl-pds">'</span></span>;
<span class="pl-k">GRANT</span> <span class="pl-k">&lt;</span>messagelog_admin_user<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>superuser<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> CREATE,TEMPORARY,CONNECT <span class="pl-k">ON</span> DATABASE <span class="pl-k">&lt;</span>messagelog_database<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>messagelog_admin_user<span class="pl-k">&gt;</span>;
\c <span class="pl-k">&lt;</span>messagelog_database<span class="pl-k">&gt;</span>
CREATE SCHEMA <span class="pl-k">&lt;</span>messagelog_schema<span class="pl-k">&gt;</span> AUTHORIZATION <span class="pl-k">&lt;</span>messagelog_admin_user<span class="pl-k">&gt;</span>;
<span class="pl-k">REVOKE</span> ALL <span class="pl-k">ON</span> SCHEMA public <span class="pl-k">FROM</span> PUBLIC;
<span class="pl-k">GRANT</span> USAGE <span class="pl-k">ON</span> SCHEMA public TO <span class="pl-k">&lt;</span>messagelog_admin_user<span class="pl-k">&gt;</span>;
CREATE ROLE <span class="pl-k">&lt;</span>messagelog_database_user<span class="pl-k">&gt;</span> LOGIN PASSWORD <span class="pl-s"><span class="pl-pds">'</span>&lt;messagelog_database_user password&gt;<span class="pl-pds">'</span></span>;
<span class="pl-k">GRANT</span> <span class="pl-k">&lt;</span>messagelog_database_user<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>superuser<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> TEMPORARY,CONNECT <span class="pl-k">ON</span> DATABASE <span class="pl-k">&lt;</span>messagelog_database<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>messagelog_database_user<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> USAGE <span class="pl-k">ON</span> SCHEMA public TO <span class="pl-k">&lt;</span>messagelog_database_user<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> USAGE <span class="pl-k">ON</span> SCHEMA <span class="pl-k">&lt;</span>messagelog_schema<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>messagelog_database_user<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> <span class="pl-k">SELECT</span>,<span class="pl-k">UPDATE</span>,INSERT,<span class="pl-k">DELETE</span> <span class="pl-k">ON</span> ALL TABLES <span class="pl-k">IN</span> SCHEMA <span class="pl-k">&lt;</span>messagelog_schema<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>messagelog_database_user<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> <span class="pl-k">SELECT</span>,<span class="pl-k">UPDATE</span> <span class="pl-k">ON</span> ALL SEQUENCES <span class="pl-k">IN</span> SCHEMA <span class="pl-k">&lt;</span>messagelog_schema<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>messagelog_database_user<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> EXECUTE <span class="pl-k">ON</span> ALL FUNCTIONS <span class="pl-k">IN</span> SCHEMA <span class="pl-k">&lt;</span>messagelog_schema<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>messagelog_database_user<span class="pl-k">&gt;</span>;</pre></div>
<p><strong>op-monitor</strong> (optional, required by xroad-opmonitor)</p>
<p>If operational monitoring is going to be installed, run additionally the following commands. Again, the database and role names can be customized to suit your environment.
By default, the database is named <code>op-monitor</code>, database user and schema both are named <code>opmonitor</code>, and the admin user is named with <code>_admin</code> suffix (e.g. <code>opmonitor_admin</code>).</p>
<div class="highlight highlight-source-sql"><pre>CREATE DATABASE <span class="pl-k">&lt;</span>opmonitor_database<span class="pl-k">&gt;</span> ENCODING <span class="pl-s"><span class="pl-pds">'</span>UTF8<span class="pl-pds">'</span></span>;
<span class="pl-k">REVOKE</span> ALL <span class="pl-k">ON</span> DATABASE <span class="pl-k">&lt;</span>opmonitor_database<span class="pl-k">&gt;</span> <span class="pl-k">FROM</span> PUBLIC;
CREATE ROLE <span class="pl-k">&lt;</span>opmonitor_admin_user<span class="pl-k">&gt;</span> LOGIN PASSWORD <span class="pl-s"><span class="pl-pds">'</span>&lt;opmonitor_admin_user password&gt;<span class="pl-pds">'</span></span>;
<span class="pl-k">GRANT</span> <span class="pl-k">&lt;</span>opmonitor_admin_user<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>superuser<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> CREATE,TEMPORARY,CONNECT <span class="pl-k">ON</span> DATABASE <span class="pl-k">&lt;</span>opmonitor_database<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>opmonitor_admin_user<span class="pl-k">&gt;</span>;
\c <span class="pl-k">&lt;</span>opmonitor_database<span class="pl-k">&gt;</span>
CREATE SCHEMA <span class="pl-k">&lt;</span>opmonitor_schema<span class="pl-k">&gt;</span> AUTHORIZATION <span class="pl-k">&lt;</span>opmonitor_admin_user<span class="pl-k">&gt;</span>;
<span class="pl-k">REVOKE</span> ALL <span class="pl-k">ON</span> SCHEMA public <span class="pl-k">FROM</span> PUBLIC;
<span class="pl-k">GRANT</span> USAGE <span class="pl-k">ON</span> SCHEMA public TO <span class="pl-k">&lt;</span>opmonitor_admin_user<span class="pl-k">&gt;</span>;
CREATE ROLE <span class="pl-k">&lt;</span>database_user<span class="pl-k">&gt;</span> LOGIN PASSWORD <span class="pl-s"><span class="pl-pds">'</span>&lt;opmonitor_database_user password&gt;<span class="pl-pds">'</span></span>;
<span class="pl-k">GRANT</span> <span class="pl-k">&lt;</span>opmonitor_database_user<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>superuser<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> TEMPORARY,CONNECT <span class="pl-k">ON</span> DATABASE <span class="pl-k">&lt;</span>opmonitor_database<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>opmonitor_database_user<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> USAGE <span class="pl-k">ON</span> SCHEMA public TO <span class="pl-k">&lt;</span>opmonitor_database_user<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> USAGE <span class="pl-k">ON</span> SCHEMA <span class="pl-k">&lt;</span>opmonitor_schema<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>opmonitor_database_user<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> <span class="pl-k">SELECT</span>,<span class="pl-k">UPDATE</span>,INSERT,<span class="pl-k">DELETE</span> <span class="pl-k">ON</span> ALL TABLES <span class="pl-k">IN</span> SCHEMA <span class="pl-k">&lt;</span>opmonitor_schema<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>opmonitor_database_user<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> <span class="pl-k">SELECT</span>,<span class="pl-k">UPDATE</span> <span class="pl-k">ON</span> ALL SEQUENCES <span class="pl-k">IN</span> SCHEMA <span class="pl-k">&lt;</span>opmonitor_schema<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>opmonitor_database_user<span class="pl-k">&gt;</span>;
<span class="pl-k">GRANT</span> EXECUTE <span class="pl-k">ON</span> ALL FUNCTIONS <span class="pl-k">IN</span> SCHEMA <span class="pl-k">&lt;</span>opmonitor_schema<span class="pl-k">&gt;</span> TO <span class="pl-k">&lt;</span>opmonitor_database_user<span class="pl-k">&gt;</span>;</pre></div>
<p>Lastly, customize the database connection properties to match the values used when creating the database.</p>
<p>Note. When using Microsoft Azure PostgreSQL, the user names need to be in format <code>username@hostname</code> in the properties files.</p>
<p>Create the configuration file <code>/etc/xroad.properties</code>.</p>
<div class="highlight highlight-source-shell"><pre>sudo touch /etc/xroad.properties
sudo chown root:root /etc/xroad.properties
sudo chmod 600 /etc/xroad.properties</pre></div>
<p>Edit <code>/etc/xroad.properties</code> and add/update the following properties (if you customized the role names, use your own). The admin users are used to run database migrations during the install and upgrades.</p>
<div class="highlight highlight-source-ini"><pre><span class="pl-k">serverconf.database.admin_user</span> = &lt;serverconf_admin_user&gt;
<span class="pl-k">serverconf.database.admin_password</span> = &lt;serverconf_admin_user password&gt;
<span class="pl-k">messagelog.database.admin_user</span> = &lt;messagelog_admin_user&gt;
<span class="pl-k">messagelog.database.admin_password</span> = &lt;messagelog_admin_user password&gt;
<span class="pl-k">op-monitor.database.admin_user</span> = &lt;opmonitor_admin_user&gt;
<span class="pl-k">op-monitor.database.admin_password</span> = &lt;opmonitor_admin_user password&gt;</pre></div>
<p>Create the <code>/etc/xroad/db.properties</code> file</p>
<div class="highlight highlight-source-shell"><pre>sudo mkdir /etc/xroad
sudo chown xroad:xroad /etc/xroad
sudo chmod 751 /etc/xroad
sudo touch /etc/xroad/db.properties
sudo chmod 0640 /etc/xroad/db.properties
sudo chown xroad:xroad /etc/xroad/db.properties</pre></div>
<p>Edit the <code>/etc/xroad/db.properties</code> file and add/update the following connection properties (if you customized the database, user, and/or role names, use the customized values).
The database connection url format is <code>jdbc:postgresql://&lt;database host&gt;:&lt;port&gt;/&lt;database name&gt;</code></p>
<div class="highlight highlight-source-ini"><pre><span class="pl-k">serverconf.hibernate.connection.url</span> = jdbc:postgresql://&lt;database host&gt;:&lt;port&gt;/&lt;serverconf_database&gt;
<span class="pl-k">serverconf.hibernate.connection.username</span> = &lt;serverconf_database_user&gt;
<span class="pl-k">serverconf.hibernate.connection.password</span> = &lt;serverconf_database_user password&gt;
<span class="pl-k">serverconf.hibernate.hikari.dataSource.currentSchema</span> = &lt;serverconf_schema&gt;,public

<span class="pl-k">messagelog.hibernate.connection.url</span> = jdbc:postgresql://&lt;database host&gt;:&lt;port&gt;/&lt;messagelog_database&gt;
<span class="pl-k">messagelog.hibernate.connection.username</span> = &lt;messagelog_database_user&gt;
<span class="pl-k">messagelog.hibernate.connection.password</span> = &lt;messagelog_database_user password&gt;
<span class="pl-k">messagelog.hibernate.hikari.dataSource.currentSchema</span> = &lt;messagelog_schema&gt;,public

<span class="pl-k">op-monitor.hibernate.connection.url</span> = jdbc:postgresql://&lt;database host&gt;:&lt;port&gt;/&lt;opmonitor_database&gt;
<span class="pl-k">op-monitor.hibernate.connection.username</span> = &lt;opmonitor_database_user&gt;
<span class="pl-k">op-monitor.hibernate.connection.password</span> = &lt;opmonitor_database_user password&gt;
<span class="pl-k">op-monitor.hibernate.hikari.dataSource.currentSchema</span> = &lt;opmonitor_schema&gt;,public</pre></div>
    </article>
  </body>
</html>
